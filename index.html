<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AssetGuard AI 盤點系統</title>
    
    <!-- Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Import Map for Google GenAI SDK -->
        <style>
        body {
            -webkit-tap-highlight-color: transparent;
            overscroll-behavior-y: none;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        }
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 4px; height: 4px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 2px; }
        
        /* Lightbox Transition */
        .fade-enter-active, .fade-leave-active { transition: opacity 0.2s; }
        .fade-enter-from, .fade-leave-to { opacity: 0; }
        
        /* PDF Preview Container (Hidden from view usually) */
        .pdf-hidden {
            position: fixed;
            top: 0;
            left: 0;
            z-index: -100;
            opacity: 0;
            pointer-events: none;
        }

        /* Loading Spinner */
        .loader {
            border: 3px solid #f3f3f3;
            border-radius: 50%;
            border-top: 3px solid #3b82f6;
            width: 20px;
            height: 20px;
            -webkit-animation: spin 1s linear infinite; /* Safari */
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-900 h-screen overflow-hidden selection:bg-blue-100">

    <div id="app" class="h-full flex flex-col relative">
        
        <!-- ================= VIEWS ================= -->

        <!-- 1. CATEGORIES VIEW -->
        <div v-if="view === 'CATEGORIES'" class="h-full flex flex-col">
            <header class="bg-white px-4 py-4 flex justify-between items-center shadow-sm sticky top-0 z-10">
                <h1 class="text-xl font-extrabold text-blue-900 flex items-center">
                    <i data-lucide="list" class="w-6 h-6 mr-2 text-blue-600"></i>
                    資產盤點目錄
                </h1>
                <button @click="view = 'SETTINGS'" class="p-2 text-gray-500 hover:bg-gray-100 rounded-full">
                    <i data-lucide="settings" class="w-6 h-6"></i>
                </button>
            </header>

            <main class="flex-1 overflow-y-auto p-4 pb-20">
                <div class="grid grid-cols-1 gap-4">
                    <div v-for="cat in categories" :key="cat.id" 
                         @click="enterCategory(cat)"
                         class="bg-white p-5 rounded-xl shadow-sm border border-gray-100 flex items-center justify-between active:bg-gray-50 transition-colors cursor-pointer">
                        <div class="flex items-center">
                            <div class="bg-blue-100 p-3 rounded-lg mr-4 text-blue-600">
                                <i data-lucide="folder-plus" class="w-6 h-6"></i>
                            </div>
                            <div>
                                <h3 class="text-lg font-bold text-gray-800">{{ cat.name }}</h3>
                                <p class="text-sm text-gray-500">{{ cat.description || '點擊進入盤點' }}</p>
                            </div>
                        </div>
                        <div class="flex items-center">
                            <button @click.stop="deleteCategory(cat.id)" class="mr-3 p-2 text-gray-300 hover:text-red-500">
                                <i data-lucide="trash-2" class="w-5 h-5"></i>
                            </button>
                            <i data-lucide="chevron-right" class="text-gray-400 w-5 h-5"></i>
                        </div>
                    </div>

                    <button @click="showCategoryModal = true" class="border-2 border-dashed border-gray-300 p-4 rounded-xl flex flex-col items-center justify-center text-gray-400 hover:border-blue-500 hover:text-blue-500 transition-colors">
                        <i data-lucide="plus" class="w-8 h-8 mb-2"></i>
                        <span class="font-medium">新增目錄 / 盤點專案</span>
                    </button>
                </div>
            </main>
        </div>

        <!-- 2. ASSET LIST VIEW -->
        <div v-if="view === 'ASSET_LIST'" class="h-full flex flex-col">
            <header class="bg-white shadow-sm sticky top-0 z-10 flex flex-col">
                <div class="px-4 py-3 flex items-center justify-between border-b border-gray-100">
                    <div class="flex items-center">
                        <button @click="view = 'CATEGORIES'" class="mr-2 -ml-2 p-2 rounded-full hover:bg-gray-100">
                            <i data-lucide="chevron-left" class="w-6 h-6 text-gray-600"></i>
                        </button>
                        <h1 class="text-lg font-bold text-gray-800 truncate max-w-[200px]">{{ activeCategory?.name }}</h1>
                    </div>
                    <div class="flex gap-2">
                        <button @click="generatePDF" :disabled="isPdfGenerating" class="p-2 text-blue-600 hover:bg-blue-50 rounded-full flex items-center gap-1">
                            <div v-if="isPdfGenerating" class="loader"></div>
                            <i v-else data-lucide="download" class="w-5 h-5"></i>
                        </button>
                        <button @click="openAddAsset" class="bg-blue-600 text-white px-3 py-1.5 rounded-lg text-sm font-medium flex items-center shadow-md active:bg-blue-700">
                            <i data-lucide="plus" class="w-4 h-4 mr-1"></i> 新增
                        </button>
                    </div>
                </div>
                
                <!-- Search -->
                <div class="px-4 py-2 bg-gray-50 border-b">
                    <div class="relative">
                        <i data-lucide="search" class="absolute left-3 top-2.5 w-4 h-4 text-gray-400"></i>
                        <input type="text" v-model="searchTerm" placeholder="搜尋編號、名稱或地點..." 
                               class="w-full pl-9 pr-4 py-2 rounded-lg border border-gray-200 text-sm focus:ring-2 focus:ring-blue-500 outline-none">
                    </div>
                </div>
            </header>

            <main class="flex-1 overflow-y-auto p-3 space-y-3 bg-gray-100 pb-20">
                <div v-if="filteredAssets.length === 0" class="flex flex-col items-center justify-center py-20 text-gray-400">
                    <i data-lucide="alert-circle" class="w-12 h-12 mb-3 opacity-20"></i>
                    <p>此目錄尚無資產</p>
                </div>

                <div v-for="asset in filteredAssets" :key="asset.id" 
                     @click="editAsset(asset)"
                     class="bg-white rounded-lg shadow-sm overflow-hidden flex h-28 active:scale-[0.99] transition-transform">
                    
                    <!-- Thumbnail -->
                    <div class="w-28 bg-gray-200 flex-shrink-0 relative cursor-zoom-in"
                         @click.stop="openLightbox(asset.photos, 0)">
                        <img v-if="asset.photos.length > 0" :src="asset.photos[0]" class="w-full h-full object-cover">
                        <div v-else class="w-full h-full flex items-center justify-center text-gray-400 text-xs">No Photo</div>
                        
                        <div v-if="asset.photos.length > 1" class="absolute bottom-1 right-1 bg-black/50 text-white text-[10px] px-1.5 rounded-full">
                            +{{ asset.photos.length - 1 }}
                        </div>
                    </div>

                    <!-- Info -->
                    <div class="flex-1 p-3 flex flex-col justify-between min-w-0 relative">
                        <div>
                            <div class="flex justify-between items-start">
                                <h3 class="font-bold text-gray-900 truncate mr-2 text-sm">{{ asset.name }}</h3>
                                <span class="text-xs font-mono bg-gray-100 text-gray-600 px-1.5 py-0.5 rounded">{{ asset.assetId }}</span>
                            </div>
                            <p class="text-xs text-gray-500 mt-1 truncate">SN: <span class="font-mono">{{ asset.serialNumber || '-' }}</span></p>
                        </div>
                        
                        <div class="flex items-end justify-between mt-2">
                            <div class="flex items-center text-xs text-blue-600 bg-blue-50 px-2 py-1 rounded max-w-[70%]">
                                <i data-lucide="map-pin" class="w-3 h-3 mr-1 flex-shrink-0"></i>
                                <span class="truncate">{{ asset.location || '未指定位置' }}</span>
                            </div>
                            <div v-if="asset.note" class="w-2 h-2 bg-orange-500 rounded-full mb-2 mr-2"></div>
                        </div>

                        <button @click.stop="deleteAsset(asset.id)" class="absolute bottom-2 right-2 p-1.5 text-gray-300 hover:text-red-500 hover:bg-red-50 rounded">
                            <i data-lucide="trash-2" class="w-4 h-4"></i>
                        </button>
                    </div>
                </div>
            </main>
        </div>

        <!-- 3. ASSET FORM VIEW -->
        <div v-if="view === 'ASSET_FORM'" class="h-full flex flex-col bg-white">
            <header class="bg-white border-b px-4 py-3 flex items-center justify-between shadow-sm sticky top-0 z-20">
                <div class="flex items-center">
                    <button @click="view = 'ASSET_LIST'" class="p-2 mr-2 -ml-2 rounded-full hover:bg-gray-100">
                        <i data-lucide="arrow-left" class="w-6 h-6 text-gray-700"></i>
                    </button>
                    <h1 class="text-xl font-bold text-gray-800">{{ editingAssetId ? '編輯資產' : '新增資產' }}</h1>
                </div>
                <button @click="saveAsset" class="bg-blue-600 text-white px-4 py-2 rounded-lg font-medium flex items-center shadow-sm active:scale-95 transition-transform">
                    <i data-lucide="save" class="w-4 h-4 mr-2"></i> 儲存
                </button>
            </header>

            <div class="flex-1 overflow-y-auto p-4 space-y-6 pb-20">
                <!-- Photos -->
                <div class="space-y-3">
                    <label class="block text-sm font-semibold text-gray-700">照片 (最多 3 張，點擊可放大)</label>
                    <div class="flex gap-3 overflow-x-auto pb-2">
                        <div v-for="(photo, idx) in formData.photos" :key="idx" 
                             class="relative flex-shrink-0 w-24 h-24 rounded-lg overflow-hidden border border-gray-200 shadow-sm group">
                            <img :src="photo" class="w-full h-full object-cover" @click="openLightbox(formData.photos, idx)">
                            <button @click.stop="removePhoto(idx)" class="absolute top-1 right-1 bg-black/50 text-white rounded-full p-1">
                                <i data-lucide="x" class="w-3 h-3"></i>
                            </button>
                        </div>
                        
                        <div v-if="formData.photos.length < 3" 
                             @click="$refs.fileInput.click()"
                             class="w-24 h-24 flex flex-col items-center justify-center border-2 border-dashed border-gray-300 rounded-lg text-gray-400 hover:border-blue-500 hover:text-blue-500 bg-gray-50 flex-shrink-0 cursor-pointer">
                            <i data-lucide="camera" class="w-8 h-8 mb-1"></i>
                            <span class="text-xs">拍照/上傳</span>
                        </div>
                        <input type="file" ref="fileInput" class="hidden" accept="image/*" capture="environment" @change="handleImageUpload">
                    </div>

                    <button v-if="formData.photos.length > 0" 
                            @click="analyzeImage"
                            :disabled="isAnalyzing"
                            class="w-full py-3 rounded-lg flex items-center justify-center font-medium transition-colors border"
                            :class="isAnalyzing ? 'bg-purple-100 text-purple-400' : 'bg-purple-50 text-purple-700 hover:bg-purple-100 border-purple-200'">
                        <div v-if="isAnalyzing" class="loader mr-2"></div>
                        <i v-else data-lucide="sparkles" class="w-5 h-5 mr-2"></i>
                        {{ isAnalyzing ? 'AI 分析中...' : '以照片資訊快速帶入（目前需手動填寫）' }}
                    </button>
                </div>

                <!-- Fields -->
                <div class="space-y-4">
                    <!-- Name -->
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-1">資產名稱</label>
                        <input type="text" list="names-list" v-model="formData.name" placeholder="例如：MacBook Pro"
                               class="w-full border rounded-lg px-4 py-3 text-lg focus:ring-2 focus:ring-blue-500 outline-none">
                        <datalist id="names-list">
                            <option v-for="n in settings.savedNames" :value="n"></option>
                        </datalist>
                    </div>

                    <div class="grid grid-cols-2 gap-4">
                        <!-- Asset ID -->
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-1">資產編號</label>
                            <input type="text" list="prefix-list" v-model="formData.assetId" placeholder="0700-0253"
                                   class="w-full border rounded-lg pl-3 pr-2 py-3 focus:ring-2 focus:ring-blue-500 outline-none">
                            <datalist id="prefix-list">
                                <option v-for="p in settings.savedPrefixes" :value="p"></option>
                            </datalist>
                        </div>
                        <!-- S/N -->
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-1">序列號 (S/N)</label>
                            <input type="text" v-model="formData.serialNumber" placeholder="X1Y2Z3..."
                                   class="w-full border rounded-lg px-3 py-3 focus:ring-2 focus:ring-blue-500 outline-none font-mono text-sm">
                        </div>
                    </div>

                    <!-- Location -->
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-1">資產地點</label>
                        <input type="text" list="locations-list" v-model="formData.location" placeholder="例如：會議室 A"
                               class="w-full border rounded-lg px-4 py-3 focus:ring-2 focus:ring-blue-500 outline-none">
                        <datalist id="locations-list">
                            <option v-for="l in settings.savedLocations" :value="l"></option>
                        </datalist>
                    </div>

                    <!-- Note -->
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-1">備註 (移動需求)</label>
                        <textarea v-model="formData.note" placeholder="若資產需要移動，請填寫目標地點..."
                                  class="w-full border rounded-lg px-4 py-3 focus:ring-2 focus:ring-blue-500 outline-none h-24 resize-none"></textarea>
                    </div>
                </div>
            </div>
        </div>

        <!-- 4. SETTINGS VIEW -->
        <div v-if="view === 'SETTINGS'" class="h-full flex flex-col bg-white">
            <div class="bg-white border-b px-4 py-3 flex items-center shadow-sm sticky top-0 z-10">
                <button @click="view = 'CATEGORIES'" class="p-2 mr-2 rounded-full hover:bg-gray-100">
                    <i data-lucide="arrow-left" class="w-6 h-6 text-gray-700"></i>
                </button>
                <h1 class="text-xl font-bold text-gray-800">資料庫設定</h1>
            </div>

            <!-- Tabs -->
            <div class="flex border-b border-gray-200">
                <button @click="settingsTab = 'names'" class="flex-1 py-3 text-sm font-medium" :class="settingsTab === 'names' ? 'text-blue-600 border-b-2 border-blue-600' : 'text-gray-500'">資產名稱</button>
                <button @click="settingsTab = 'locations'" class="flex-1 py-3 text-sm font-medium" :class="settingsTab === 'locations' ? 'text-blue-600 border-b-2 border-blue-600' : 'text-gray-500'">地點清單</button>
                <button @click="settingsTab = 'prefixes'" class="flex-1 py-3 text-sm font-medium" :class="settingsTab === 'prefixes' ? 'text-blue-600 border-b-2 border-blue-600' : 'text-gray-500'">編號規則</button>
            </div>

            <!-- Content -->
            <div class="flex-1 overflow-y-auto p-4">
                <div class="flex gap-2 mb-4">
                    <input type="text" v-model="newSettingItem" @keyup.enter="addSettingItem" 
                           :placeholder="settingsTabName"
                           class="flex-1 border rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 outline-none">
                    <button @click="addSettingItem" class="bg-blue-600 text-white p-2 rounded-lg hover:bg-blue-700">
                        <i data-lucide="plus" class="w-5 h-5"></i>
                    </button>
                </div>

                <div class="space-y-2">
                    <div v-for="(item, idx) in currentSettingsList" :key="idx" class="flex items-center justify-between bg-gray-50 p-3 rounded-lg border">
                        <span class="text-gray-800">{{ item }}</span>
                        <button @click="removeSettingItem(idx)" class="text-red-500 p-2 hover:bg-red-50 rounded-full">
                            <i data-lucide="trash-2" class="w-4 h-4"></i>
                        </button>
                    </div>
                    <div v-if="currentSettingsList.length === 0" class="text-center text-gray-400 py-8">暫無資料</div>
                </div>
            </div>
        </div>

        <!-- ================= MODALS ================= -->

        <!-- Add Category Modal -->
        <div v-if="showCategoryModal" class="fixed inset-0 bg-black/60 z-50 flex items-center justify-center p-4 backdrop-blur-sm">
            <div class="bg-white rounded-2xl w-full max-w-sm p-6 shadow-2xl">
                <h3 class="text-xl font-bold mb-2 text-gray-800">新增盤點目錄</h3>
                <input type="text" v-model="newCategoryName" placeholder="例如：3F 會議室"
                       class="w-full border border-gray-300 rounded-lg p-3 mb-6 outline-none focus:ring-2 focus:ring-blue-500 text-lg">
                <div class="flex gap-3">
                    <button @click="showCategoryModal = false" class="flex-1 py-3 bg-gray-100 rounded-xl font-semibold text-gray-700">取消</button>
                    <button @click="createCategory" :disabled="!newCategoryName" class="flex-1 py-3 bg-blue-600 rounded-xl font-semibold text-white disabled:bg-blue-300">建立</button>
                </div>
            </div>
        </div>

        <!-- Lightbox -->
        <transition name="fade">
            <div v-if="lightbox.isOpen" @click="closeLightbox" class="fixed inset-0 bg-black z-[999] flex items-center justify-center">
                <button @click="closeLightbox" class="absolute top-4 right-4 text-white p-2 bg-white/20 rounded-full z-20">
                    <i data-lucide="x" class="w-8 h-8"></i>
                </button>
                
                <!-- Nav -->
                <button v-if="lightbox.images.length > 1" @click.stop="prevImage" class="absolute left-4 top-1/2 -translate-y-1/2 text-white p-3 bg-white/20 rounded-full z-20">
                    <i data-lucide="chevron-left" class="w-8 h-8"></i>
                </button>
                <button v-if="lightbox.images.length > 1" @click.stop="nextImage" class="absolute right-4 top-1/2 -translate-y-1/2 text-white p-3 bg-white/20 rounded-full z-20">
                    <i data-lucide="chevron-right" class="w-8 h-8"></i>
                </button>

                <!-- Counter -->
                <div v-if="lightbox.images.length > 1" class="absolute bottom-8 left-1/2 -translate-x-1/2 text-white bg-black/50 px-3 py-1 rounded-full text-sm">
                    {{ lightbox.currentIndex + 1 }} / {{ lightbox.images.length }}
                </div>

                <img :src="lightbox.images[lightbox.currentIndex]" class="max-w-full max-h-full object-contain p-2">
            </div>
        </transition>

        <!-- PDF Template (Visible only when generating) -->
        <div v-if="isPdfPreview && activeCategory" class="fixed inset-0 z-[200] bg-white overflow-auto flex justify-center">
            <div id="pdf-report-content" class="bg-white w-[210mm] p-[15mm] text-gray-900 box-border">
                
                <div class="mb-6 pb-4 border-b-2 border-gray-800 flex justify-between items-end">
                    <div>
                        <h1 class="text-3xl font-extrabold tracking-wide mb-1">資產盤點清單</h1>
                        <p class="text-gray-600 font-medium">分類目錄: <span class="text-black">{{ activeCategory.name }}</span></p>
                    </div>
                    <div class="text-right text-sm text-gray-500">
                        <div>匯出日期: {{ new Date().toLocaleDateString('zh-TW') }}</div>
                    </div>
                </div>

                <table class="w-full border-collapse border border-gray-400 text-sm table-fixed">
                    <thead>
                        <tr class="bg-gray-100 text-gray-800">
                            <th class="border border-gray-400 p-2 w-[5%] text-center">#</th>
                            <th class="border border-gray-400 p-2 w-[25%] text-left">照片紀錄</th>
                            <th class="border border-gray-400 p-2 w-[35%] text-left">資產詳細資訊</th>
                            <th class="border border-gray-400 p-2 w-[15%] text-left">位置</th>
                            <th class="border border-gray-400 p-2 w-[20%] text-left">備註</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr v-for="(asset, index) in assets" :key="asset.id" class="align-top">
                            <td class="border border-gray-400 p-2 text-center">{{ index + 1 }}</td>
                            <td class="border border-gray-400 p-2">
                                <div v-if="asset.photos.length > 0" class="grid grid-cols-2 gap-1">
                                    <div v-for="(photo, i) in asset.photos.slice(0, 4)" :key="i" class="aspect-square w-full overflow-hidden border border-gray-200">
                                        <img :src="photo" class="w-full h-full object-cover">
                                    </div>
                                </div>
                                <span v-else class="text-gray-400 text-xs">- 無照片 -</span>
                            </td>
                            <td class="border border-gray-400 p-2 break-words">
                                <div class="space-y-1">
                                    <div><span class="font-bold text-gray-600 text-xs block">資產名稱:</span><span class="font-bold text-lg leading-tight block">{{ asset.name }}</span></div>
                                    <div><span class="font-bold text-gray-600 text-xs block">編號:</span><span class="font-mono text-sm block">{{ asset.assetId }}</span></div>
                                    <div><span class="font-bold text-gray-600 text-xs block">序號 (S/N):</span><span class="font-mono text-gray-700 text-xs break-all block">{{ asset.serialNumber || 'N/A' }}</span></div>
                                </div>
                            </td>
                            <td class="border border-gray-400 p-2 break-words">{{ asset.location }}</td>
                            <td class="border border-gray-400 p-2 text-gray-600 break-words text-xs">{{ asset.note }}</td>
                        </tr>
                    </tbody>
                </table>

                <div class="mt-8 pt-4 border-t border-gray-200 flex justify-between text-xs text-gray-400">
                    <div>Generated by AssetGuard AI</div>
                    <div>本頁共計: <span class="text-black font-bold">{{ assets.length }}</span> 筆資產</div>
                </div>
            </div>
        </div>

    </div>

    <!-- Application Logic -->
    <script type="module">
        const { createApp } = Vue;

        
        // --- Database Service ---
        const DB_NAME = 'AssetGuardDB';
        const DB_VERSION = 1;
        
        class DBService {
            constructor() { this.db = null; }
            connect() {
                return new Promise((resolve, reject) => {
                    const request = indexedDB.open(DB_NAME, DB_VERSION);
                    request.onerror = () => reject('DB Error');
                    request.onsuccess = (e) => { this.db = e.target.result; resolve(); };
                    request.onupgradeneeded = (e) => {
                        const db = e.target.result;
                        if (!db.objectStoreNames.contains('assets')) {
                            const store = db.createObjectStore('assets', { keyPath: 'id' });
                            store.createIndex('categoryId', 'categoryId', { unique: false });
                        }
                        if (!db.objectStoreNames.contains('categories')) db.createObjectStore('categories', { keyPath: 'id' });
                        if (!db.objectStoreNames.contains('settings')) db.createObjectStore('settings', { keyPath: 'id' });
                    };
                });
            }
            // Generic helpers
            getAll(storeName) {
                return new Promise(resolve => {
                    if (!this.db) return resolve([]);
                    const tx = this.db.transaction(storeName, 'readonly');
                    const req = tx.objectStore(storeName).getAll();
                    req.onsuccess = () => resolve(req.result);
                });
            }
            save(storeName, item) {
                return new Promise(resolve => {
                    const tx = this.db.transaction(storeName, 'readwrite');
                    tx.objectStore(storeName).put(item);
                    tx.oncomplete = () => resolve();
                });
            }
            delete(storeName, id) {
                 return new Promise(resolve => {
                    const tx = this.db.transaction(storeName, 'readwrite');
                    tx.objectStore(storeName).delete(id);
                    tx.oncomplete = () => resolve();
                });
            }
            getByIndex(storeName, indexName, value) {
                return new Promise(resolve => {
                    const tx = this.db.transaction(storeName, 'readonly');
                    const idx = tx.objectStore(storeName).index(indexName);
                    const req = idx.getAll(value);
                    req.onsuccess = () => resolve(req.result);
                });
            }
        }
        const db = new DBService();

        // --- Gemini Service ---
        
        // （已移除 Gemini 相關程式碼）

        // --- Vue App ---
        createApp({
            data() {
                return {
                    view: 'CATEGORIES', // CATEGORIES, ASSET_LIST, ASSET_FORM, SETTINGS
                    categories: [],
                    assets: [],
                    activeCategory: null,
                    settings: {
                        savedNames: ['筆記型電腦', '顯示器', '辦公桌'],
                        savedLocations: ['會議室 A', '庫房', '主要辦公區'],
                        savedPrefixes: ['ASSET-', 'IT-', 'OFFICE-'],
                        lastUsedPrefix: '',
                        lastUsedSequence: 1
                    },
                    
                    // Asset Form
                    editingAssetId: null,
                    formData: {
                        categoryId: '', photos: [], name: '', serialNumber: '', assetId: '', location: '', note: ''
                    },
                    isAnalyzing: false,

                    // Settings
                    settingsTab: 'names',
                    newSettingItem: '',

                    // Search
                    searchTerm: '',

                    // Modals
                    showCategoryModal: false,
                    newCategoryName: '',
                    
                    // Lightbox
                    lightbox: { isOpen: false, images: [], currentIndex: 0 },

                    // PDF
                    isPdfPreview: false,
                    isPdfGenerating: false
                }
            },
            computed: {
                filteredAssets() {
                    const term = this.searchTerm.toLowerCase();
                    return this.assets.filter(a => 
                        a.name.toLowerCase().includes(term) ||
                        a.assetId.toLowerCase().includes(term) ||
                        (a.location && a.location.toLowerCase().includes(term)) ||
                        (a.serialNumber && a.serialNumber.toLowerCase().includes(term))
                    );
                },
                currentSettingsList() {
                    if (this.settingsTab === 'names') return this.settings.savedNames;
                    if (this.settingsTab === 'locations') return this.settings.savedLocations;
                    return this.settings.savedPrefixes;
                },
                settingsTabName() {
                    if (this.settingsTab === 'names') return '新增名稱...';
                    if (this.settingsTab === 'locations') return '新增地點...';
                    return '新增前綴...';
                }
            },
            async mounted() {
                await db.connect();
                this.loadCategories();
                this.loadSettings();
                this.$nextTick(() => lucide.createIcons());
            },
            updated() {
                this.$nextTick(() => lucide.createIcons());
            },
            methods: {
                // Categories
                async loadCategories() {
                    this.categories = await db.getAll('categories');
                },
                async createCategory() {
                    if (!this.newCategoryName.trim()) return;
                    const cat = { id: crypto.randomUUID(), name: this.newCategoryName, description: '' };
                    await db.save('categories', cat);
                    this.newCategoryName = '';
                    this.showCategoryModal = false;
                    this.loadCategories();
                },
                async deleteCategory(id) {
                    if(!confirm('確定要刪除此目錄嗎？')) return;
                    await db.delete('categories', id);
                    this.loadCategories();
                },
                async enterCategory(cat) {
                    this.activeCategory = cat;
                    this.assets = await db.getByIndex('assets', 'categoryId', cat.id);
                    this.view = 'ASSET_LIST';
                },

                // Assets
                async deleteAsset(id) {
                    if(!confirm('確定要刪除此資產嗎？')) return;
                    await db.delete('assets', id);
                    if(this.activeCategory) this.enterCategory(this.activeCategory);
                },
                openAddAsset() {
                    this.editingAssetId = null;
                    this.formData = {
                        categoryId: this.activeCategory.id,
                        photos: [], name: '', serialNumber: '', assetId: '', location: '', note: ''
                    };
                    // Auto-ID
                    if (this.settings.lastUsedPrefix) {
                        const nextId = `${this.settings.lastUsedPrefix}${(this.settings.lastUsedSequence + 1).toString().padStart(4, '0')}`;
                        this.formData.assetId = nextId;
                    }
                    this.view = 'ASSET_FORM';
                },
                editAsset(asset) {
                    this.editingAssetId = asset.id;
                    this.formData = JSON.parse(JSON.stringify(asset));
                    this.view = 'ASSET_FORM';
                },
                async saveAsset() {
                    if (!this.formData.name) return alert('請輸入名稱');
                    const asset = {
                        ...this.formData,
                        id: this.editingAssetId || crypto.randomUUID(),
                        updatedAt: Date.now()
                    };
                    await db.save('assets', asset);
                    
                    // Update settings for auto-increment logic (simple)
                    if (this.formData.assetId) {
                         // Extract prefix if possible? (Skipping complex logic for brevity)
                    }

                    if (this.activeCategory) await this.enterCategory(this.activeCategory);
                },
                
                // Photos & AI
                handleImageUpload(e) {
                    const file = e.target.files[0];
                    if (!file) return;
                    const reader = new FileReader();
                    reader.onload = (evt) => {
                        this.resizeImage(evt.target.result, 800, 0.8, (resized) => {
                            if (this.formData.photos.length < 3) this.formData.photos.push(resized);
                        });
                    };
                    reader.readAsDataURL(file);
                },
                resizeImage(base64, maxWidth, quality, callback) {
                    const img = new Image();
                    img.src = base64;
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        let w = img.width, h = img.height;
                        if (w > maxWidth) { h = Math.round((h * maxWidth) / w); w = maxWidth; }
                        canvas.width = w; canvas.height = h;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, w, h);
                        callback(canvas.toDataURL('image/jpeg', quality));
                    };
                },
                removePhoto(idx) {
                    this.formData.photos.splice(idx, 1);
                },
                async analyzeImage() {
                    alert('目前未啟用自動分析功能，請自行填寫欄位');
                },

                // Lightbox
                openLightbox(images, idx) {
                    this.lightbox = { isOpen: true, images, currentIndex: idx };
                },
                closeLightbox() {
                    this.lightbox.isOpen = false;
                },
                nextImage() {
                    this.lightbox.currentIndex = (this.lightbox.currentIndex + 1) % this.lightbox.images.length;
                },
                prevImage() {
                    this.lightbox.currentIndex = (this.lightbox.currentIndex - 1 + this.lightbox.images.length) % this.lightbox.images.length;
                },

                // Settings
                async loadSettings() {
                    const s = await db.getAll('settings');
                    if (s && s.length > 0) {
                        // Merge assuming 'global' id
                        const global = s.find(x => x.id === 'global');
                        if (global) this.settings = { ...this.settings, ...global };
                    }
                },
                async saveSettings() {
                    await db.save('settings', { ...this.settings, id: 'global' });
                },
                addSettingItem() {
                    if (!this.newSettingItem.trim()) return;
                    if (this.settingsTab === 'names') this.settings.savedNames.push(this.newSettingItem.trim());
                    if (this.settingsTab === 'locations') this.settings.savedLocations.push(this.newSettingItem.trim());
                    if (this.settingsTab === 'prefixes') this.settings.savedPrefixes.push(this.newSettingItem.trim());
                    this.saveSettings();
                    this.newSettingItem = '';
                },
                removeSettingItem(idx) {
                    if (this.settingsTab === 'names') this.settings.savedNames.splice(idx, 1);
                    if (this.settingsTab === 'locations') this.settings.savedLocations.splice(idx, 1);
                    if (this.settingsTab === 'prefixes') this.settings.savedPrefixes.splice(idx, 1);
                    this.saveSettings();
                },

                // PDF
                generatePDF() {
                    if (!this.activeCategory) return;
                    this.isPdfPreview = true;
                    this.isPdfGenerating = true;
                    
                    // Wait for DOM
                    setTimeout(() => {
                        const element = document.getElementById('pdf-report-content');
                        if (!element) return;
                        
                        const opt = {
                            margin: 0,
                            filename: `${this.activeCategory.name}_AssetReport.pdf`,
                            image: { type: 'jpeg', quality: 0.98 },
                            html2canvas: { scale: 2, useCORS: true, scrollY: 0 },
                            jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
                        };
                        
                        // @ts-ignore
                        html2pdf().set(opt).from(element).save().then(() => {
                            this.isPdfPreview = false;
                            this.isPdfGenerating = false;
                        }).catch(e => {
                            alert('匯出失敗');
                            this.isPdfPreview = false;
                            this.isPdfGenerating = false;
                        });
                    }, 800);
                }
            }
        }).mount('#app');
    </script>
</body>
</html>