<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AssetGuard AI ç›¤é»ç³»çµ±</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#2563eb">
    <!-- iOS PWA full-screen -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="AssetGuard">
    <link rel="apple-touch-icon" href="icon-192.png">
    
    <!-- Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <!-- Import Map for Google GenAI SDK -->
        <style>
        body {
            -webkit-tap-highlight-color: transparent;
            overscroll-behavior-y: none;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        }
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 4px; height: 4px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 2px; }
        
        /* Lightbox Transition */
        .fade-enter-active, .fade-leave-active { transition: opacity 0.2s; }
        .fade-enter-from, .fade-leave-to { opacity: 0; }
        
        /* PDF Preview Container (Hidden from view usually) */
        .pdf-hidden {
            position: fixed;
            top: 0;
            left: 0;
            z-index: -100;
            opacity: 0;
            pointer-events: none;
        }

        /* Loading Spinner */
        .loader {
            border: 3px solid #f3f3f3;
            border-radius: 50%;
            border-top: 3px solid #3b82f6;
            width: 20px;
            height: 20px;
            -webkit-animation: spin 1s linear infinite; /* Safari */
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-900 h-screen overflow-hidden selection:bg-blue-100">

    <div id="app" class="h-full flex flex-col relative">
        
        <!-- ================= VIEWS ================= -->

        <!-- 1. CATEGORIES VIEW -->
        <div v-if="view === 'CATEGORIES'" class="h-full flex flex-col">
            <header class="bg-white px-4 py-4 flex justify-between items-center shadow-sm sticky top-0 z-10">
                <h1 class="text-xl font-extrabold text-blue-900 flex items-center">
                    <span class="w-6 h-6 mr-2 text-blue-600">ğŸ“‹</span>
                    è³‡ç”¢ç›¤é»ç›®éŒ„
                </h1>
                <div class="flex items-center gap-2">
                    <!-- åŒ¯å…¥ JSON ç‚ºæ–°ç›®éŒ„ -->
                    <button
                        @click="$refs.categoryImportInput.click()"
                        class="p-2 text-gray-600 hover:bg-gray-100 rounded-full text-xs"
                        title="å¾ JSON åŒ¯å…¥ç‚ºæ–°ç›®éŒ„">
                        â¬†JSON
                    </button>
                    <input
                        type="file"
                        ref="categoryImportInput"
                        class="hidden"
                        accept="application/json"
                        @change="importCategoryData">

                    <!-- è¨­å®š -->
                    <button @click="view = 'SETTINGS'" class="p-2 text-gray-500 hover:bg-gray-100 rounded-full">
                        <span class="w-6 h-6">âš™</span>
                    </button>
                </div>
            </header>

            <main class="flex-1 overflow-y-auto p-4 pb-20">
                <div class="grid grid-cols-1 gap-4">
                    <div v-for="cat in categories" :key="cat.id" 
                         @click="enterCategory(cat)"
                         class="bg-white p-5 rounded-xl shadow-sm border border-gray-100 flex items-center justify-between active:bg-gray-50 transition-colors cursor-pointer">
                        <div class="flex items-center">
                            <div class="bg-blue-100 p-3 rounded-lg mr-4 text-blue-600">
                                <span class="w-6 h-6">ğŸ“</span>
                            </div>
                            <div>
                                <h3 class="text-lg font-bold text-gray-800">{{ cat.name }}</h3>
                                <p class="text-sm text-gray-500">{{ cat.description || 'é»æ“Šé€²å…¥ç›¤é»' }}</p>
                            </div>
                        </div>
                        <div class="flex items-center">
                            <!-- åŒ¯å‡ºé€™å€‹ç›®éŒ„ + åº•ä¸‹æ‰€æœ‰è³‡ç”¢ -->
                            <button
                                @click.stop="exportCategoryData(cat)"
                                class="mr-2 p-2 text-gray-500 hover:bg-gray-100 rounded-full text-xs"
                                title="åŒ¯å‡ºæ­¤ç›®éŒ„èˆ‡æ‰€æœ‰è³‡ç”¢ (JSON)">
                                â¬‡JSON
                            </button>
                            <button @click.stop="deleteCategory(cat.id)" class="mr-3 p-2 text-red-500 hover:text-red-600 hover:bg-red-50 rounded-full">
                                <span class="text-lg leading-none">ğŸ—‘</span>
                            </button>
                            <span class="text-gray-400 w-5 h-5">â€º</span>
                        </div>
                    </div>

                    <button @click="showCategoryModal = true" class="border-2 border-dashed border-gray-300 p-4 rounded-xl flex flex-col items-center justify-center text-gray-400 hover:border-blue-500 hover:text-blue-500 transition-colors">
                        <span class="w-8 h-8 mb-2 text-2xl leading-none">ï¼‹</span>
                        <span class="font-medium">æ–°å¢ç›®éŒ„ / ç›¤é»å°ˆæ¡ˆ</span>
                    </button>
                </div>
            </main>
        </div>

        <!-- 2. ASSET LIST VIEW -->
        <div v-if="view === 'ASSET_LIST'" class="h-full flex flex-col">
            <header class="bg-white shadow-sm sticky top-0 z-10 flex flex-col">
                <div class="px-4 py-3 flex items-center justify-between border-b border-gray-100">
                    <div class="flex items-center">
                        <button @click="view = 'CATEGORIES'" class="mr-2 -ml-2 p-2 rounded-full hover:bg-gray-100">
                            <span class="w-6 h-6 text-gray-600">â†</span>
                        </button>
                        <h1 class="text-lg font-bold text-gray-800 truncate max-w-[200px]">{{ activeCategory?.name }}</h1>
                    </div>
                    <div class="flex gap-2">
                        <button @click="generatePDF" :disabled="isPdfGenerating" class="p-2 text-blue-600 hover:bg-blue-50 rounded-full flex items-center gap-1">
                            <div v-if="isPdfGenerating" class="loader"></div>
                            <span v-else class="w-5 h-5">â¬‡</span>
                        </button>
                        <button @click="openAddAsset" class="bg-blue-600 text-white px-3 py-1.5 rounded-lg text-sm font-medium flex items-center shadow-md active:bg-blue-700">
                            <span class="w-4 h-4 mr-1">ï¼‹</span> æ–°å¢
                        </button>
                    </div>
                </div>
                
                <!-- Search -->
                <div class="px-4 py-2 bg-gray-50 border-b">
                    <div class="relative">
                        <span class="absolute left-3 top-2.5 w-4 h-4 text-gray-400">ğŸ”</span>
                        <input type="text" v-model="searchTerm" placeholder="æœå°‹ç·¨è™Ÿã€åç¨±æˆ–åœ°é»..." 
                               class="w-full pl-9 pr-4 py-2 rounded-lg border border-gray-200 text-sm focus:ring-2 focus:ring-blue-500 outline-none">
                    </div>
                </div>
            </header>

            <main class="flex-1 overflow-y-auto p-3 space-y-3 bg-gray-100 pb-20">
                <div v-if="filteredAssets.length === 0" class="flex flex-col items-center justify-center py-20 text-gray-400">
                    <span class="w-12 h-12 mb-3 opacity-20 text-3xl">!</span>
                    <p>æ­¤ç›®éŒ„å°šç„¡è³‡ç”¢</p>
                </div>

                <div v-for="asset in filteredAssets" :key="asset.id" 
                     @click="editAsset(asset)"
                     class="bg-white rounded-lg shadow-sm overflow-hidden flex h-28 active:scale-[0.99] transition-transform">
                    
                    <!-- Thumbnail -->
                    <div class="w-28 bg-gray-200 flex-shrink-0 relative cursor-zoom-in"
                         @click.stop="openLightbox(asset.photos, 0)">
                        <img v-if="asset.photos.length > 0" :src="asset.photos[0]" class="w-full h-full object-cover">
                        <div v-else class="w-full h-full flex items-center justify-center text-gray-400 text-xs">No Photo</div>
                        
                        <div v-if="asset.photos.length > 1" class="absolute bottom-1 right-1 bg-black/50 text-white text-[10px] px-1.5 rounded-full">
                            +{{ asset.photos.length - 1 }}
                        </div>
                    </div>

                    <!-- Info -->
                    <div class="flex-1 p-3 flex flex-col justify-between min-w-0 relative">
                        <div>
                            <div class="flex justify-between items-start">
                                <h3 class="font-bold text-gray-900 truncate mr-2 text-sm">{{ asset.name }}</h3>
                                <span class="text-xs font-mono bg-gray-100 text-gray-600 px-1.5 py-0.5 rounded">{{ asset.assetId }}</span>
                            </div>
                            <p class="text-xs text-gray-500 mt-1 truncate">SN: <span class="font-mono">{{ asset.serialNumber || '-' }}</span></p>
                        </div>
                        
                        <div class="flex items-end justify-between mt-2">
                            <div class="flex items-center text-xs text-blue-600 bg-blue-50 px-2 py-1 rounded max-w-[70%]">
                                <span class="w-3 h-3 mr-1 flex-shrink-0">ğŸ“</span>
                                <span class="truncate">{{ asset.location || 'æœªæŒ‡å®šä½ç½®' }}</span>
                            </div>
                            </div>

                        <button @click.stop="deleteAsset(asset.id)" class="absolute bottom-2 right-2 p-1.5 text-red-500 hover:text-red-600 hover:bg-red-50 rounded-full">
                            <span class="text-lg leading-none">ğŸ—‘</span>
                        </button>
                    </div>
                </div>
            </main>
        </div>

        <!-- 3. ASSET FORM VIEW -->
        <div v-if="view === 'ASSET_FORM'" class="h-full flex flex-col bg-white">
            <header class="bg-white border-b px-4 py-3 flex items-center justify-between shadow-sm sticky top-0 z-20">
                <div class="flex items-center">
                    <button @click="view = 'ASSET_LIST'" class="p-2 mr-2 -ml-2 rounded-full hover:bg-gray-100">
                        <span class="w-6 h-6 text-gray-700">â†</span>
                    </button>
                    <h1 class="text-xl font-bold text-gray-800">{{ editingAssetId ? 'ç·¨è¼¯è³‡ç”¢' : 'æ–°å¢è³‡ç”¢' }}</h1>
                </div>
                <button @click="saveAsset" class="bg-blue-600 text-white px-4 py-2 rounded-lg font-medium flex items-center shadow-sm active:scale-95 transition-transform">
                    <span class="w-4 h-4 mr-2">ğŸ’¾</span> å„²å­˜
                </button>
            </header>

            <div class="flex-1 overflow-y-auto p-4 space-y-6 pb-20">
                <!-- Photos -->
                <div class="space-y-3">
                    <label class="block text-sm font-semibold text-gray-700">ç…§ç‰‡ (æœ€å¤š 3 å¼µï¼Œé»æ“Šå¯æ”¾å¤§)</label>
                    <div class="flex gap-3 overflow-x-auto pb-2">
                        <div v-for="(photo, idx) in formData.photos" :key="idx" 
                             class="relative flex-shrink-0 w-24 h-24 rounded-lg overflow-hidden border border-gray-200 shadow-sm group">
                            <img :src="photo" class="w-full h-full object-cover" @click="openLightbox(formData.photos, idx)">
                            <button @click.stop="removePhoto(idx)" class="absolute top-1 right-1 bg-black/50 text-white rounded-full p-1">
                                <span class="w-3 h-3 text-xs leading-none">âœ•</span>
                            </button>
                        </div>
                        
                        <div v-if="formData.photos.length < 3" 
                             @click="$refs.fileInput.click()"
                             class="w-24 h-24 flex flex-col items-center justify-center border-2 border-dashed border-gray-300 rounded-lg text-gray-400 hover:border-blue-500 hover:text-blue-500 bg-gray-50 flex-shrink-0 cursor-pointer">
                            <span class="w-8 h-8 mb-1 text-2xl leading-none">ğŸ“·</span>
                            <span class="text-xs">æ‹ç…§/ä¸Šå‚³</span>
                        </div>
                        <input type="file" ref="fileInput" class="hidden" accept="image/*" multiple @change="handleImageUpload">
                    </div>

                    <button v-if="formData.photos.length > 0" 
                            @click="analyzeImage"
                            :disabled="isAnalyzing"
                            class="w-full py-3 rounded-lg flex items-center justify-center font-medium transition-colors border"
                            :class="isAnalyzing ? 'bg-purple-100 text-purple-400' : 'bg-purple-50 text-purple-700 hover:bg-purple-100 border-purple-200'">
                        <div v-if="isAnalyzing" class="loader mr-2"></div>
                        <span v-else class="w-5 h-5 mr-2">âœ¨</span>
                        {{ isAnalyzing ? 'AI åˆ†æä¸­...' : 'ä»¥ç…§ç‰‡è³‡è¨Šå¿«é€Ÿå¸¶å…¥ï¼ˆç›®å‰éœ€æ‰‹å‹•å¡«å¯«ï¼‰' }}
                    </button>
                </div>

                <!-- Fields -->
                <div class="space-y-4">
                    <!-- Name -->
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-1">è³‡ç”¢åç¨±</label>
                        <input type="text" list="names-list" v-model="formData.name" placeholder="ä¾‹å¦‚ï¼šMacBook Pro"
                               class="w-full border rounded-lg px-4 py-3 text-lg focus:ring-2 focus:ring-blue-500 outline-none">
                        <datalist id="names-list">
                            <option v-for="n in settings.savedNames" :value="n"></option>
                        </datalist>
                    </div>

                    <div class="grid grid-cols-2 gap-4">
                        <!-- Asset ID -->
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-1">è³‡ç”¢ç·¨è™Ÿ</label>
                            <input type="text" list="prefix-list" v-model="formData.assetId" placeholder="0700-0253"
                                   class="w-full border rounded-lg pl-3 pr-2 py-3 focus:ring-2 focus:ring-blue-500 outline-none">
                            <datalist id="prefix-list">
                                <option v-for="p in settings.savedPrefixes" :value="p"></option>
                            </datalist>
                        </div>
                        <!-- S/N -->
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-1">åºåˆ—è™Ÿ (S/N)</label>
                            <input type="text" v-model="formData.serialNumber" placeholder="X1Y2Z3..."
                                   class="w-full border rounded-lg px-3 py-3 focus:ring-2 focus:ring-blue-500 outline-none font-mono text-sm">
                        </div>
                    </div>

                    <!-- Location -->
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-1">è³‡ç”¢åœ°é»</label>
                        <input type="text" list="locations-list" v-model="formData.location" placeholder="ä¾‹å¦‚ï¼šæœƒè­°å®¤ A"
                               class="w-full border rounded-lg px-4 py-3 focus:ring-2 focus:ring-blue-500 outline-none">
                        <datalist id="locations-list">
                            <option v-for="l in settings.savedLocations" :value="l"></option>
                        </datalist>
                    </div>

                    <!-- Note -->
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-1">å‚™è¨» (ç§»å‹•éœ€æ±‚)</label>
                        <textarea v-model="formData.note" placeholder="è‹¥è³‡ç”¢éœ€è¦ç§»å‹•ï¼Œè«‹å¡«å¯«ç›®æ¨™åœ°é»..."
                                  class="w-full border rounded-lg px-4 py-3 focus:ring-2 focus:ring-blue-500 outline-none h-24 resize-none"></textarea>
                    </div>
                </div>
            </div>
        </div>

        <!-- 4. SETTINGS VIEW -->
        <div v-if="view === 'SETTINGS'" class="h-full flex flex-col bg-white">
            <div class="bg-white border-b px-4 py-3 flex items-center shadow-sm sticky top-0 z-10">
                <button @click="view = 'CATEGORIES'" class="p-2 mr-2 rounded-full hover:bg-gray-100">
                    <span class="w-6 h-6 text-gray-700">â†</span>
                </button>
                <h1 class="text-xl font-bold text-gray-800">è³‡æ–™åº«è¨­å®š</h1>
            </div>

            <!-- Tabs -->
            <div class="flex border-b border-gray-200">
                <button @click="settingsTab = 'names'" class="flex-1 py-3 text-sm font-medium" :class="settingsTab === 'names' ? 'text-blue-600 border-b-2 border-blue-600' : 'text-gray-500'">è³‡ç”¢åç¨±</button>
                <button @click="settingsTab = 'locations'" class="flex-1 py-3 text-sm font-medium" :class="settingsTab === 'locations' ? 'text-blue-600 border-b-2 border-blue-600' : 'text-gray-500'">åœ°é»æ¸…å–®</button>
                <button @click="settingsTab = 'prefixes'" class="flex-1 py-3 text-sm font-medium" :class="settingsTab === 'prefixes' ? 'text-blue-600 border-b-2 border-blue-600' : 'text-gray-500'">ç·¨è™Ÿè¦å‰‡</button>
            </div>

            <!-- Content -->
            <div class="flex-1 overflow-y-auto p-4">
                <div class="flex gap-2 mb-4">
                    <input type="text" v-model="newSettingItem" @keyup.enter="addSettingItem" 
                           :placeholder="settingsTabName"
                           class="flex-1 border rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 outline-none">
                    <button @click="addSettingItem" class="bg-blue-600 text-white p-2 rounded-lg hover:bg-blue-700">
                        <span class="w-5 h-5 text-lg leading-none">ï¼‹</span>
                    </button>
                </div>

                <div class="space-y-2">
                    <div v-for="(item, idx) in currentSettingsList" :key="idx" class="flex items-center justify-between bg-gray-50 p-3 rounded-lg border">
                        <span class="text-gray-800">{{ item }}</span>
                        <button @click="removeSettingItem(idx)" class="text-red-500 p-2 hover:bg-red-50 rounded-full">
                            <span class="text-lg leading-none">ğŸ—‘</span>
                        </button>
                    </div>
                    <div v-if="currentSettingsList.length === 0" class="text-center text-gray-400 py-8">æš«ç„¡è³‡æ–™</div>
                </div>
            </div>
        </div>

        <!-- ================= MODALS ================= -->

        <!-- Add Category Modal -->
        <div v-if="showCategoryModal" class="fixed inset-0 bg-black/60 z-50 flex items-center justify-center p-4 backdrop-blur-sm">
            <div class="bg-white rounded-2xl w-full max-w-sm p-6 shadow-2xl">
                <h3 class="text-xl font-bold mb-2 text-gray-800">æ–°å¢ç›¤é»ç›®éŒ„</h3>
                <input type="text" v-model="newCategoryName" placeholder="ä¾‹å¦‚ï¼š3F æœƒè­°å®¤"
                       class="w-full border border-gray-300 rounded-lg p-3 mb-6 outline-none focus:ring-2 focus:ring-blue-500 text-lg">
                <div class="flex gap-3">
                    <button @click="showCategoryModal = false" class="flex-1 py-3 bg-gray-100 rounded-xl font-semibold text-gray-700">å–æ¶ˆ</button>
                    <button @click="createCategory" :disabled="!newCategoryName" class="flex-1 py-3 bg-blue-600 rounded-xl font-semibold text-white disabled:bg-blue-300">å»ºç«‹</button>
                </div>
            </div>
        </div>

        <!-- Lightbox -->
        <transition name="fade">
            <div v-if="lightbox.isOpen" @click="closeLightbox" class="fixed inset-0 bg-black z-[999] flex items-center justify-center">
                <button @click="closeLightbox" class="absolute top-4 right-4 text-white p-2 bg-white/20 rounded-full z-20">
                    <span class="text-3xl leading-none">âœ•</span>
                </button>
                
                <!-- Nav -->
                <button v-if="lightbox.images.length > 1" @click.stop="prevImage" class="absolute left-4 top-1/2 -translate-y-1/2 text-white p-3 bg-white/20 rounded-full z-20">
                    <span class="text-3xl leading-none">â€¹</span>
                </button>
                <button v-if="lightbox.images.length > 1" @click.stop="nextImage" class="absolute right-4 top-1/2 -translate-y-1/2 text-white p-3 bg-white/20 rounded-full z-20">
                    <span class="text-3xl leading-none">â€º</span>
                </button>

                <!-- Counter -->
                <div v-if="lightbox.images.length > 1" class="absolute bottom-8 left-1/2 -translate-x-1/2 text-white bg-black/50 px-3 py-1 rounded-full text-sm">
                    {{ lightbox.currentIndex + 1 }} / {{ lightbox.images.length }}
                </div>

                <img :src="lightbox.images[lightbox.currentIndex]" class="max-w-full max-h-full object-contain p-2">
            </div>
        </transition>

        <!-- PDF Template (Visible only when generating) -->
        <div v-if="isPdfPreview && activeCategory" class="fixed inset-0 z-[200] bg-white overflow-auto flex justify-center">
            <div id="pdf-report-content" class="bg-white w-[210mm] p-[15mm] text-gray-900 box-border">
                
                <div class="mb-6 pb-4 border-b-2 border-gray-800 flex justify-between items-end">
                    <div>
                        <h1 class="text-3xl font-extrabold tracking-wide mb-1">è³‡ç”¢ç›¤é»æ¸…å–®</h1>
                        <p class="text-gray-600 font-medium">åˆ†é¡ç›®éŒ„: <span class="text-black">{{ activeCategory.name }}</span></p>
                    </div>
                    <div class="text-right text-sm text-gray-500">
                        <div>åŒ¯å‡ºæ—¥æœŸ: {{ new Date().toLocaleDateString('zh-TW') }}</div>
                    </div>
                </div>

                <table class="w-full border-collapse border border-gray-400 text-sm table-fixed">
                    <thead>
                        <tr class="bg-gray-100 text-gray-800">
                            <th class="border border-gray-400 p-2 w-[5%] text-center">#</th>
                            <th class="border border-gray-400 p-2 w-[25%] text-left">ç…§ç‰‡ç´€éŒ„</th>
                            <th class="border border-gray-400 p-2 w-[35%] text-left">è³‡ç”¢è©³ç´°è³‡è¨Š</th>
                            <th class="border border-gray-400 p-2 w-[15%] text-left">ä½ç½®</th>
                            <th class="border border-gray-400 p-2 w-[20%] text-left">å‚™è¨»</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr v-for="(asset, index) in assets" :key="asset.id" class="align-top">
                            <td class="border border-gray-400 p-2 text-center">{{ index + 1 }}</td>
                            <td class="border border-gray-400 p-2">
                                <div v-if="asset.photos.length > 0" class="grid grid-cols-2 gap-1">
                                    <div v-for="(photo, i) in asset.photos.slice(0, 4)" :key="i" class="aspect-square w-full overflow-hidden border border-gray-200">
                                        <img :src="photo" class="w-full h-full object-cover">
                                    </div>
                                </div>
                                <span v-else class="text-gray-400 text-xs">- ç„¡ç…§ç‰‡ -</span>
                            </td>
                            <td class="border border-gray-400 p-2 break-words">
                                <div class="space-y-1">
                                    <div><span class="font-bold text-gray-600 text-xs block">è³‡ç”¢åç¨±:</span><span class="font-bold text-lg leading-tight block">{{ asset.name }}</span></div>
                                    <div><span class="font-bold text-gray-600 text-xs block">ç·¨è™Ÿ:</span><span class="font-mono text-sm block">{{ asset.assetId }}</span></div>
                                    <div><span class="font-bold text-gray-600 text-xs block">åºè™Ÿ (S/N):</span><span class="font-mono text-gray-700 text-xs break-all block">{{ asset.serialNumber || 'N/A' }}</span></div>
                                </div>
                            </td>
                            <td class="border border-gray-400 p-2 break-words">{{ asset.location }}</td>
                            <td class="border border-gray-400 p-2 text-gray-600 break-words text-xs">{{ asset.note }}</td>
                        </tr>
                    </tbody>
                </table>

                <div class="mt-8 pt-4 border-t border-gray-200 flex justify-between text-xs text-gray-400">
                    <div>Generated by AssetGuard AI</div>
                    <div>æœ¬é å…±è¨ˆ: <span class="text-black font-bold">{{ assets.length }}</span> ç­†è³‡ç”¢</div>
                </div>
            </div>
        </div>

    </div>

    <!-- Application Logic -->
    <script type="module">
        const { createApp } = Vue;

        
        // --- Database Service ---
        const DB_NAME = 'AssetGuardDB';
        const DB_VERSION = 1;
        
        class DBService {
            constructor() { this.db = null; }
            connect() {
                return new Promise((resolve, reject) => {
                    const request = indexedDB.open(DB_NAME, DB_VERSION);
                    request.onerror = () => reject('DB Error');
                    request.onsuccess = (e) => { this.db = e.target.result; resolve(); };
                    request.onupgradeneeded = (e) => {
                        const db = e.target.result;
                        if (!db.objectStoreNames.contains('assets')) {
                            const store = db.createObjectStore('assets', { keyPath: 'id' });
                            store.createIndex('categoryId', 'categoryId', { unique: false });
                        }
                        if (!db.objectStoreNames.contains('categories')) db.createObjectStore('categories', { keyPath: 'id' });
                        if (!db.objectStoreNames.contains('settings')) db.createObjectStore('settings', { keyPath: 'id' });
                    };
                });
            }
            // Generic helpers
            getAll(storeName) {
                return new Promise(resolve => {
                    if (!this.db) return resolve([]);
                    const tx = this.db.transaction(storeName, 'readonly');
                    const req = tx.objectStore(storeName).getAll();
                    req.onsuccess = () => resolve(req.result);
                });
            }
            save(storeName, item) {
                return new Promise((resolve, reject) => {
                    try {
                        // Convert Vue reactive / Proxy objects into plain data
                        const plain = JSON.parse(JSON.stringify(item));
                        const tx = this.db.transaction(storeName, 'readwrite');
                        tx.objectStore(storeName).put(plain);
                        tx.oncomplete = () => resolve();
                        tx.onerror = () => reject(tx.error);
                    } catch (error) {
                        console.error('DB save error', error, item);
                        reject(error);
                    }
                });
            }
            delete(storeName, id) {
                 return new Promise(resolve => {
                    const tx = this.db.transaction(storeName, 'readwrite');
                    tx.objectStore(storeName).delete(id);
                    tx.oncomplete = () => resolve();
                });
            }
            getByIndex(storeName, indexName, value) {
                return new Promise(resolve => {
                    const tx = this.db.transaction(storeName, 'readonly');
                    const idx = tx.objectStore(storeName).index(indexName);
                    const req = idx.getAll(value);
                    req.onsuccess = () => resolve(req.result);
                });
            }
        }
        const db = new DBService();

        // --- Gemini Service ---
        
        // ï¼ˆå·²ç§»é™¤ Gemini ç›¸é—œç¨‹å¼ç¢¼ï¼‰

        // --- Vue App ---
        createApp({
            data() {
                return {
                    view: 'CATEGORIES', // CATEGORIES, ASSET_LIST, ASSET_FORM, SETTINGS
                    categories: [],
                    assets: [],
                    activeCategory: null,
                    settings: {
                        savedNames: ['ç­†è¨˜å‹é›»è…¦', 'é¡¯ç¤ºå™¨', 'è¾¦å…¬æ¡Œ'],
                        savedLocations: ['æœƒè­°å®¤ A', 'åº«æˆ¿', 'ä¸»è¦è¾¦å…¬å€'],
                        savedPrefixes: ['ASSET-', 'IT-', 'OFFICE-'],
                        lastUsedPrefix: '',
                        lastUsedSequence: 1
                    },
                    
                    // Asset Form
                    editingAssetId: null,
                    formData: {
                        categoryId: '', photos: [], name: '', serialNumber: '', assetId: '', location: '', note: ''
                    },
                    isAnalyzing: false,

                    // Settings
                    settingsTab: 'names',
                    newSettingItem: '',

                    // Search
                    searchTerm: '',

                    // Modals
                    showCategoryModal: false,
                    newCategoryName: '',
                    
                    // Lightbox
                    lightbox: { isOpen: false, images: [], currentIndex: 0 },

                    // PDF
                    isPdfPreview: false,
                    isPdfGenerating: false
                }
            },
            computed: {
                filteredAssets() {
                    const term = this.searchTerm.toLowerCase();
                    return this.assets.filter(a => 
                        a.name.toLowerCase().includes(term) ||
                        a.assetId.toLowerCase().includes(term) ||
                        (a.location && a.location.toLowerCase().includes(term)) ||
                        (a.serialNumber && a.serialNumber.toLowerCase().includes(term))
                    );
                },
                currentSettingsList() {
                    if (this.settingsTab === 'names') return this.settings.savedNames;
                    if (this.settingsTab === 'locations') return this.settings.savedLocations;
                    return this.settings.savedPrefixes;
                },
                settingsTabName() {
                    if (this.settingsTab === 'names') return 'æ–°å¢åç¨±...';
                    if (this.settingsTab === 'locations') return 'æ–°å¢åœ°é»...';
                    return 'æ–°å¢å‰ç¶´...';
                }
            },
            async mounted() {
                await db.connect();
                this.loadCategories();
                this.loadSettings();
                // Icons removed: no external DOM manipulation needed
            },
            updated() {
                // no-op
            },
            methods: {
                // Categories
                async loadCategories() {
                    this.categories = await db.getAll('categories');
                },
                async createCategory() {
                    if (!this.newCategoryName.trim()) return;
                    const cat = { id: crypto.randomUUID(), name: this.newCategoryName, description: '' };
                    await db.save('categories', cat);
                    this.newCategoryName = '';
                    this.showCategoryModal = false;
                    this.loadCategories();
                },
                async deleteCategory(id) {
                    if(!confirm('ç¢ºå®šè¦åˆªé™¤æ­¤ç›®éŒ„å—ï¼Ÿ')) return;
                    await db.delete('categories', id);
                    this.loadCategories();
                },
                async enterCategory(cat) {
                    this.activeCategory = cat;
                    this.assets = await db.getByIndex('assets', 'categoryId', cat.id);
                    this.view = 'ASSET_LIST';
                },

                // Assets
                async deleteAsset(id) {
                    if(!confirm('ç¢ºå®šè¦åˆªé™¤æ­¤è³‡ç”¢å—ï¼Ÿ')) return;
                    await db.delete('assets', id);
                    if(this.activeCategory) this.enterCategory(this.activeCategory);
                },
                openAddAsset() {
                    this.editingAssetId = null;
                    this.formData = {
                        categoryId: this.activeCategory.id,
                        photos: [], name: '', serialNumber: '', assetId: '', location: '', note: ''
                    };
                    // Auto-ID
                    if (this.settings.lastUsedPrefix) {
                        const nextId = `${this.settings.lastUsedPrefix}${(this.settings.lastUsedSequence + 1).toString().padStart(4, '0')}`;
                        this.formData.assetId = nextId;
                    }
                    this.view = 'ASSET_FORM';
                },
                editAsset(asset) {
                    this.editingAssetId = asset.id;
                    this.formData = JSON.parse(JSON.stringify(asset));
                    this.view = 'ASSET_FORM';
                },
                async saveAsset() {
                    if (!this.formData.name) return alert('è«‹è¼¸å…¥åç¨±');
                    const asset = {
                        ...this.formData,
                        id: this.editingAssetId || crypto.randomUUID(),
                        updatedAt: Date.now()
                    };
                    await db.save('assets', asset);
                    
                    // Update settings for auto-increment logic (simple)
                    if (this.formData.assetId) {
                         // Extract prefix if possible? (Skipping complex logic for brevity)
                    }

                    if (this.activeCategory) await this.enterCategory(this.activeCategory);
                },
                
                // Photos & AI
                handleImageUpload(e) {
                    const file = e.target.files[0];
                    if (!file) return;
                    const reader = new FileReader();
                    reader.onload = (evt) => {
                        this.resizeImage(evt.target.result, 800, 0.8, (resized) => {
                            if (this.formData.photos.length < 3) this.formData.photos.push(resized);
                        });
                    };
                    reader.readAsDataURL(file);
                },
                resizeImage(base64, maxWidth, quality, callback) {
                    const img = new Image();
                    img.src = base64;
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        let w = img.width, h = img.height;
                        if (w > maxWidth) { h = Math.round((h * maxWidth) / w); w = maxWidth; }
                        canvas.width = w; canvas.height = h;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, w, h);
                        callback(canvas.toDataURL('image/jpeg', quality));
                    };
                },
                removePhoto(idx) {
                    this.formData.photos.splice(idx, 1);
                },
                async analyzeImage() {
                    alert('ç›®å‰æœªå•Ÿç”¨è‡ªå‹•åˆ†æåŠŸèƒ½ï¼Œè«‹è‡ªè¡Œå¡«å¯«æ¬„ä½');
                },

                // Lightbox
                openLightbox(images, idx) {
                    this.lightbox = { isOpen: true, images, currentIndex: idx };
                },
                closeLightbox() {
                    this.lightbox.isOpen = false;
                },
                nextImage() {
                    this.lightbox.currentIndex = (this.lightbox.currentIndex + 1) % this.lightbox.images.length;
                },
                prevImage() {
                    this.lightbox.currentIndex = (this.lightbox.currentIndex - 1 + this.lightbox.images.length) % this.lightbox.images.length;
                },

                // Settings
                async loadSettings() {
                    const s = await db.getAll('settings');
                    if (s && s.length > 0) {
                        // Merge assuming 'global' id
                        const global = s.find(x => x.id === 'global');
                        if (global) this.settings = { ...this.settings, ...global };
                    }
                },
                async saveSettings() {
                    await db.save('settings', { ...this.settings, id: 'global' });
                },
                addSettingItem() {
                    if (!this.newSettingItem.trim()) return;
                    if (this.settingsTab === 'names') this.settings.savedNames.push(this.newSettingItem.trim());
                    if (this.settingsTab === 'locations') this.settings.savedLocations.push(this.newSettingItem.trim());
                    if (this.settingsTab === 'prefixes') this.settings.savedPrefixes.push(this.newSettingItem.trim());
                    this.saveSettings();
                    this.newSettingItem = '';
                },
                removeSettingItem(idx) {
                    if (this.settingsTab === 'names') this.settings.savedNames.splice(idx, 1);
                    if (this.settingsTab === 'locations') this.settings.savedLocations.splice(idx, 1);
                    if (this.settingsTab === 'prefixes') this.settings.savedPrefixes.splice(idx, 1);
                    this.saveSettings();
                },

                // å°ˆæ¡ˆç›®éŒ„åŒ¯å‡º / åŒ¯å…¥
                async exportCategoryData(categoryArg) {
                    const category = categoryArg || this.activeCategory;
                    if (!category) {
                        alert('è«‹å…ˆé¸æ“‡è¦åŒ¯å‡ºçš„ç›®éŒ„');
                        return;
                    }
                    try {
                        const assets = await db.getByIndex('assets', 'categoryId', category.id);
                        const payload = {
                            type: 'AssetGuardCategoryExport',
                            version: 1,
                            exportedAt: Date.now(),
                            category,
                            assets
                        };
                        const blob = new Blob([JSON.stringify(payload, null, 2)], { type: 'application/json' });
                        const url = URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        const safeName = (category.name || 'category').replace(/[\\/:*?"<>|]/g, '_');
                        a.href = url;
                        a.download = `${safeName}-asset-export.json`;
                        document.body.appendChild(a);
                        a.click();
                        document.body.removeChild(a);
                        URL.revokeObjectURL(url);
                    } catch (e) {
                        console.error(e);
                        alert('åŒ¯å‡ºå¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
                    }
                },

                async importCategoryData(event) {
                    const file = event.target.files[0];
                    // é‡ç½® inputï¼Œé¿å…åŒä¸€æª”æ¡ˆé€£çºŒé¸æ“‡æ™‚ç„¡æ³•è§¸ç™¼ change
                    event.target.value = '';
                    if (!file) return;

                    try {
                        const text = await file.text();
                        const data = JSON.parse(text);

                        if (!data || data.type !== 'AssetGuardCategoryExport') {
                            alert('åŒ¯å…¥æª”æ¡ˆæ ¼å¼ä¸æ­£ç¢ºï¼Œè«‹ç¢ºèªæ˜¯åŒ¯å‡ºç”¢ç”Ÿçš„ JSON æª”');
                            return;
                        }

                        const originalCategory = data.category || {};
                        const originalAssets = Array.isArray(data.assets) ? data.assets : [];

                        // å»ºç«‹æ–°çš„ç›®éŒ„ idï¼Œé¿å…èˆ‡ç¾æœ‰è³‡æ–™è¡çª
                        const newCategoryId = crypto.randomUUID();
                        const newCategory = {
                            id: newCategoryId,
                            name: originalCategory.name || `åŒ¯å…¥ç›®éŒ„ (${new Date().toLocaleString('zh-TW')})`,
                            description: originalCategory.description || ''
                        };

                        await db.save('categories', newCategory);

                        // å°‡è³‡ç”¢é€ç­†åŒ¯å…¥ä¸¦æ”¹æˆæ–°çš„ categoryId / id
                        for (const asset of originalAssets) {
                            const newAsset = {
                                ...asset,
                                id: crypto.randomUUID(),
                                categoryId: newCategoryId,
                                updatedAt: Date.now()
                            };
                            await db.save('assets', newAsset);
                        }

                        // é‡æ–°è¼‰å…¥ä¸¦ç›´æ¥é€²å…¥æ–°ç›®éŒ„
                        await this.loadCategories();
                        await this.enterCategory(newCategory);

                        alert(`å·²åŒ¯å…¥ç›®éŒ„ã€Œ${newCategory.name}ã€ï¼Œå…± ${originalAssets.length} ç­†è³‡ç”¢`);
                    } catch (e) {
                        console.error(e);
                        alert('åŒ¯å…¥å¤±æ•—ï¼Œè«‹ç¢ºèªæª”æ¡ˆç‚ºæ­£ç¢ºçš„ JSON åŒ¯å‡ºæª”');
                    }
                },

                // PDF
                async generatePDF() {
                    if (!this.activeCategory) {
                        alert('è«‹å…ˆé¸æ“‡è¦åŒ¯å‡ºçš„ç›®éŒ„');
                        return;
                    }
                    
                    const category = this.activeCategory;
                    const assets = (this.filteredAssets && this.filteredAssets.length)
                        ? this.filteredAssets
                        : this.assets.filter(a => a.categoryId === category.id);
                    
                    if (!assets.length) {
                        alert('æ­¤ç›®éŒ„ç›®å‰æ²’æœ‰è³‡ç”¢å¯åŒ¯å‡º');
                        return;
                    }
                    
                    this.isPdfGenerating = true;
                    
                    try {
                        const escapeHtml = (value) => {
                            if (value === null || value === undefined) return '';
                            return String(value)
                                .replace(/&/g, '&amp;')
                                .replace(/</g, '&lt;')
                                .replace(/>/g, '&gt;')
                                .replace(/"/g, '&quot;')
                                .replace(/'/g, '&#39;');
                        };
                        
                        const rowsHtml = assets.map((asset, index) => {
                            const photos = Array.isArray(asset.photos) ? asset.photos : [];
                            const photoCells = photos.slice(0, 3).map(src => `
                                    <div style="border-radius:4px; overflow:hidden; border:1px solid #e5e7eb; width:110px; height:82px; margin-right:4px;">
                                        <img src="${escapeHtml(src)}" style="width:100%; height:100%; object-fit:cover;" />
                                    </div>
                                `).join('');
                            
                            return `
                                <tr>
                                    <td style="padding:6px 8px; border-bottom:1px solid #e5e7eb; text-align:center; font-size:11px;">${index + 1}</td>
                                    <td style="padding:6px 8px; border-bottom:1px solid #e5e7eb; font-size:11px;">
                                        <div style="display:flex; flex-direction:row; align-items:center;">${photoCells || '<span style="color:#9ca3af;">ç„¡ç…§ç‰‡</span>'}</div>
                                    </td>
                                    <td style="padding:6px 8px; border-bottom:1px solid #e5e7eb; font-size:11px;">
                                        <div><strong>è³‡ç”¢åç¨±ï¼š</strong>${escapeHtml(asset.name || '')}</div>
                                        <div><strong>è³‡ç”¢ç·¨è™Ÿï¼š</strong>${escapeHtml(asset.assetId || '')}</div>
                                        <div><strong>åºåˆ—è™Ÿï¼š</strong>${escapeHtml(asset.serialNumber || '')}</div>
                                    </td>
                                    <td style="padding:6px 8px; border-bottom:1px solid #e5e7eb; font-size:11px;">
                                        ${escapeHtml(asset.location || '')}
                                    </td>
                                    <td style="padding:6px 8px; border-bottom:1px solid #e5e7eb; font-size:11px;">
                                        ${escapeHtml(asset.note || '')}
                                    </td>
                                </tr>
                            `;
                        }).join('');
                        
                        const wrapper = document.createElement('div');
                        wrapper.id = 'pdf-temp-wrapper';
                        wrapper.style.position = 'fixed';
                        wrapper.style.inset = '0';
                        wrapper.style.opacity = '0';
                        wrapper.style.pointerEvents = 'none';
                        wrapper.style.zIndex = '-1';
                        
                        wrapper.innerHTML = `
                            <div id="pdf-report-content" style="width:210mm; padding:15mm; box-sizing:border-box; background:#ffffff; color:#111827; font-family:-apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;">
                                <div style="display:flex; justify-content:space-between; align-items:flex-end; margin-bottom:16px; padding-bottom:8px; border-bottom:2px solid #111827;">
                                    <div>
                                        <div style="font-size:24px; font-weight:800; letter-spacing:1px;">è³‡ç”¢ç›¤é»æ¸…å–®</div>
                                        <div style="font-size:12px; color:#4b5563; margin-top:4px;">
                                            åˆ†é¡ç›®éŒ„ï¼š<span style="font-weight:600; color:#111827;">${escapeHtml(category.name || '')}</span>
                                        </div>
                                    </div>
                                    <div style="text-align:right; font-size:11px; color:#6b7280;">
                                        <div>åŒ¯å‡ºæ—¥æœŸï¼š${new Date().toLocaleString('zh-TW')}</div>
                                        <div>è³‡ç”¢æ•¸é‡ï¼š${assets.length}</div>
                                    </div>
                                </div>
                                <table style="width:100%; border-collapse:collapse; table-layout:fixed; font-size:12px;">
                                    <thead>
                                        <tr>
                                            <th style="width:40px; padding:6px 8px; text-align:center; border-bottom:2px solid #111827; font-size:11px;">åº</th>
                                            <th style="width:250px; padding:6px 8px; text-align:center; border-bottom:2px solid #111827; font-size:11px;">ç…§ç‰‡è¨˜éŒ„</th>
                                            <th style="padding:6px 8px; text-align:left; border-bottom:2px solid #111827; font-size:11px;">è³‡ç”¢è©³ç´°è³‡è¨Š</th>
                                            <th style="width:100px; padding:6px 8px; text-align:left; border-bottom:2px solid #111827; font-size:11px;">ä½ç½®</th>
                                            <th style="width:110px; padding:6px 8px; text-align:left; border-bottom:2px solid #111827; font-size:11px;">å‚™è¨»</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${rowsHtml}
                                    </tbody>
                                </table>
                            </div>
                        `;
                        
                        document.body.appendChild(wrapper);
                        
                        const element = document.getElementById('pdf-report-content');
                        if (!element) {
                            document.body.removeChild(wrapper);
                            this.isPdfGenerating = false;
                            alert('å»ºç«‹ PDF å…§å®¹æ™‚ç™¼ç”ŸéŒ¯èª¤');
                            return;
                        }
                        
                        const opt = {
                            margin: 0,
                            filename: `${(category.name || 'Asset')}_AssetReport.pdf`,
                            image: { type: 'jpeg', quality: 0.98 },
                            html2canvas: { scale: 2, useCORS: true, scrollY: 0 },
                            jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
                        };
                        
                        // @ts-ignore
                        await html2pdf().set(opt).from(element).save();
                        
                        document.body.removeChild(wrapper);
                        this.isPdfGenerating = false;
                    } catch (e) {
                        console.error(e);
                        this.isPdfGenerating = false;
                        alert('åŒ¯å‡ºå¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
                    }
                }
            }
        }).mount('#app');
    </script>

    <script>
    if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
            navigator.serviceWorker.register('./sw.js').catch(err => {
                console.log('ServiceWorker registration failed:', err);
            });
        });
    }
    </script>
</body>
</html>