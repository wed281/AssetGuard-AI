<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AssetGuard AI 盤點系統</title>
    
    <!-- Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Import Map for Google GenAI SDK -->
        <style>
        body {
            -webkit-tap-highlight-color: transparent;
            overscroll-behavior-y: none;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        }
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 4px; height: 4px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 2px; }
        
        /* Lightbox Transition */
        .fade-enter-active, .fade-leave-active { transition: opacity 0.2s; }
        .fade-enter-from, .fade-leave-to { opacity: 0; }
        
        /* PDF Preview Container (Hidden from view usually) */
        .pdf-hidden {
            position: fixed;
            top: 0;
            left: 0;
            z-index: -100;
            opacity: 0;
            pointer-events: none;
        }

        /* Loading Spinner */
        .loader {
            border: 3px solid #f3f3f3;
            border-radius: 50%;
            border-top: 3px solid #3b82f6;
            width: 20px;
            height: 20px;
            -webkit-animation: spin 1s linear infinite; /* Safari */
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-900 h-screen overflow-hidden selection:bg-blue-100">

    <div id="app" class="h-full flex flex-col relative">
        
        <!-- ================= VIEWS ================= -->

        <!-- 1. CATEGORIES VIEW -->
        <div v-if="view === 'CATEGORIES'" class="h-full flex flex-col">
            <header class="bg-white px-4 py-4 flex justify-between items-center shadow-sm sticky top-0 z-10">
                <h1 class="text-xl font-extrabold text-blue-900 flex items-center">
                    <i data-lucide="list" class="w-6 h-6 mr-2 text-blue-600"></i>
                    資產盤點目錄
                </h1>
                <div class="flex items-center gap-2">
                    <button @click="openExportModal"
                            class="px-3 py-1.5 rounded-full text-xs font-medium border border-gray-200 text-gray-600 hover:bg-gray-50">
                        匯出
                    </button>
                    <label class="px-3 py-1.5 rounded-full text-xs font-medium border border-gray-200 text-gray-600 hover:bg-gray-50 cursor-pointer">
                        匯入
                        <input type="file" accept="application/json" class="hidden" @change="importBundle">
                    </label>
                    <button @click="view = 'SETTINGS'" class="p-2 text-gray-500 hover:bg-gray-100 rounded-full">
                        <i data-lucide="settings" class="w-6 h-6"></i>
                    </button>
                </div>
            </header>

            <!-- 匯出目錄選擇 Modal -->
            <div v-if="showExportModal" class="fixed inset-0 bg-black/40 flex items-center justify-center z-30">
                <div class="bg-white rounded-2xl w-[90%] max-w-md p-4 max-h-[80vh] overflow-y-auto">
                    <h2 class="text-base font-semibold mb-1">選擇要匯出的目錄</h2>
                    <p class="text-xs text-gray-500 mb-3">
                        勾選要匯出的目錄。匯出檔案會包含所選目錄及其底下所有資產資料與照片。
                    </p>

                    <div v-if="categories.length === 0" class="text-sm text-gray-500 py-4 text-center">
                        目前尚未建立任何目錄，無法匯出。
                    </div>
                    <div v-else class="space-y-2 max-h-[50vh] overflow-y-auto">
                        <label v-for="cat in categories" :key="cat.id"
                               class="flex items-center justify-between px-3 py-2 rounded-xl border border-gray-200">
                            <div class="mr-3">
                                <p class="text-sm font-medium text-gray-800">{{ cat.name }}</p>
                                <p class="text-xs text-gray-500">{{ cat.description || ' ' }}</p>
                            </div>
                            <input type="checkbox" class="w-4 h-4"
                                   :value="cat.id"
                                   v-model="exportSelection">
                        </label>
                    </div>

                    <div class="flex justify-between items-center mt-4">
                        <button @click="toggleExportSelectAll"
                                class="text-xs text-gray-600 underline">
                            全選 / 全不選
                        </button>
                        <div class="space-x-2">
                            <button @click="closeExportModal"
                                    class="px-3 py-1.5 rounded-full text-xs border border-gray-200 text-gray-600">
                                取消
                            </button>
                            <button @click="confirmExportSelection"
                                    class="px-4 py-1.5 rounded-full text-xs font-semibold bg-blue-600 text-white">
                                匯出
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <main class="flex-1 overflow-y-auto p-4 pb-20">
                <div class="grid grid-cols-1 gap-4">
                    <div v-for="cat in categories" :key="cat.id" 
                         @click="enterCategory(cat)"
                         class="bg-white p-5 rounded-xl shadow-sm border border-gray-100 flex items-center justify-between active:bg-gray-50 transition-colors cursor-pointer">
                        <div class="flex items-center">
                            <div class="bg-blue-100 p-3 rounded-lg mr-4 text-blue-600">
                                <i data-lucide="folder-plus" class="w-6 h-6"></i>
                            </div>
                            <div>
                                <h3 class="text-lg font-bold text-gray-800">{{ cat.name }}</h3>
                                <p class="text-sm text-gray-500">{{ cat.description || '點擊進入盤點' }}</p>
                            </div>
                        </div>
                        <div class="flex items-center">
                            <button @click.stop="deleteCategory(cat.id)" class="mr-3 p-2 text-red-500 hover:text-red-600 hover:bg-red-50 rounded-full">
                                <i data-lucide="trash-2" class="w-4 h-4"></i>
                            </button>
                            <i data-lucide="chevron-right" class="text-gray-400 w-5 h-5"></i>
                        </div>
                    </div>

                    <button @click="showCategoryModal = true" class="border-2 border-dashed border-gray-300 p-4 rounded-xl flex flex-col items-center justify-center text-gray-400 hover:border-blue-500 hover:text-blue-500 transition-colors">
                        <i data-lucide="plus" class="w-8 h-8 mb-2"></i>
                        <span class="font-medium">新增目錄 / 盤點專案</span>
                    </button>
                </div>
            </main>
        </div>

        <!-- 2. ASSET LIST VIEW -->
        <div v-if="view === 'ASSET_LIST'" class="h-full flex flex-col">
            <header class="bg-white shadow-sm sticky top-0 z-10 flex flex-col">
                <div class="px-4 py-3 flex items-center justify-between border-b border-gray-100">
                    <div class="flex items-center">
                        <button @click="view = 'CATEGORIES'" class="mr-2 -ml-2 p-2 rounded-full hover:bg-gray-100">
                            <i data-lucide="chevron-left" class="w-6 h-6 text-gray-600"></i>
                        </button>
                        <h1 class="text-lg font-bold text-gray-800 truncate max-w-[200px]">{{ activeCategory?.name }}</h1>
                    </div>
                    <div class="flex gap-2">
                        <button @click="generatePDF" :disabled="isPdfGenerating" class="p-2 text-blue-600 hover:bg-blue-50 rounded-full flex items-center gap-1">
                            <div v-if="isPdfGenerating" class="loader"></div>
                            <i v-else data-lucide="download" class="w-5 h-5"></i>
                        </button>
                        <button @click="openAddAsset" class="bg-blue-600 text-white px-3 py-1.5 rounded-lg text-sm font-medium flex items-center shadow-md active:bg-blue-700">
                            <i data-lucide="plus" class="w-4 h-4 mr-1"></i> 新增
                        </button>
                    </div>
                </div>
                
                <!-- Search -->
                <div class="px-4 py-2 bg-gray-50 border-b">
                    <div class="relative">
                        <i data-lucide="search" class="absolute left-3 top-2.5 w-4 h-4 text-gray-400"></i>
                        <input type="text" v-model="searchTerm" placeholder="搜尋編號、名稱或地點..." 
                               class="w-full pl-9 pr-4 py-2 rounded-lg border border-gray-200 text-sm focus:ring-2 focus:ring-blue-500 outline-none">
                    </div>
                </div>
            </header>

            <main class="flex-1 overflow-y-auto p-3 space-y-3 bg-gray-100 pb-20">
                <div v-if="filteredAssets.length === 0" class="flex flex-col items-center justify-center py-20 text-gray-400">
                    <i data-lucide="alert-circle" class="w-12 h-12 mb-3 opacity-20"></i>
                    <p>此目錄尚無資產</p>
                </div>

                <div v-for="asset in filteredAssets" :key="asset.id" 
                     @click="editAsset(asset)"
                     class="bg-white rounded-lg shadow-sm overflow-hidden flex h-28 active:scale-[0.99] transition-transform">
                    
                    <!-- Thumbnail -->
                    <div class="w-28 bg-gray-200 flex-shrink-0 relative cursor-zoom-in"
                         @click.stop="openLightbox(asset.photos, 0)">
                        <img v-if="asset.photos.length > 0" :src="asset.photos[0]" class="w-full h-full object-cover">
                        <div v-else class="w-full h-full flex items-center justify-center text-gray-400 text-xs">No Photo</div>
                        
                        <div v-if="asset.photos.length > 1" class="absolute bottom-1 right-1 bg-black/50 text-white text-[10px] px-1.5 rounded-full">
                            +{{ asset.photos.length - 1 }}
                        </div>
                    </div>

                    <!-- Info -->
                    <div class="flex-1 p-3 flex flex-col justify-between min-w-0 relative">
                        <div>
                            <div class="flex justify-between items-start">
                                <h3 class="font-bold text-gray-900 truncate mr-2 text-sm">{{ asset.name }}</h3>
                                <span class="text-xs font-mono bg-gray-100 text-gray-600 px-1.5 py-0.5 rounded">{{ asset.assetId }}</span>
                            </div>
                            <p class="text-xs text-gray-500 mt-1 truncate">SN: <span class="font-mono">{{ asset.serialNumber || '-' }}</span></p>
                        </div>
                        
                        <div class="flex items-end justify-between mt-2">
                            <div class="flex items-center text-xs text-blue-600 bg-blue-50 px-2 py-1 rounded max-w-[70%]">
                                <i data-lucide="map-pin" class="w-3 h-3 mr-1 flex-shrink-0"></i>
                                <span class="truncate">{{ asset.location || '未指定位置' }}</span>
                            </div>
                            <div v-if="asset.note" class="w-2 h-2 bg-orange-500 rounded-full mb-2 mr-2"></div>
                        </div>

                        <button @click.stop="deleteAsset(asset.id)" class="absolute bottom-2 right-2 p-1.5 text-red-500 hover:text-red-600 hover:bg-red-50 rounded-full">
                            <i data-lucide="trash-2" class="w-4 h-4"></i>
                        </button>
                    </div>
                </div>
            </main>
        </div>

        <!-- 3. ASSET FORM VIEW -->
        <div v-if="view === 'ASSET_FORM'" class="h-full flex flex-col bg-white">
            <header class="bg-white border-b px-4 py-3 flex items-center justify-between shadow-sm sticky top-0 z-20">
                <div class="flex items-center">
                    <button @click="view = 'ASSET_LIST'" class="p-2 mr-2 -ml-2 rounded-full hover:bg-gray-100">
                        <i data-lucide="arrow-left" class="w-6 h-6 text-gray-700"></i>
                    </button>
                    <h1 class="text-xl font-bold text-gray-800">{{ editingAssetId ? '編輯資產' : '新增資產' }}</h1>
                </div>
                <button @click="saveAsset" class="bg-blue-600 text-white px-4 py-2 rounded-lg font-medium flex items-center shadow-sm active:scale-95 transition-transform">
                    <i data-lucide="save" class="w-4 h-4 mr-2"></i> 儲存
                </button>
            </header>

            <div class="flex-1 overflow-y-auto p-4 space-y-6 pb-20">
                <!-- Photos -->
                <div class="space-y-3">
                    <label class="block text-sm font-semibold text-gray-700">照片 (最多 3 張，點擊可放大)</label>
                    <div class="flex gap-3 overflow-x-auto pb-2">
                        <div v-for="(photo, idx) in formData.photos" :key="idx" 
                             class="relative flex-shrink-0 w-24 h-24 rounded-lg overflow-hidden border border-gray-200 shadow-sm group">
                            <img :src="photo" class="w-full h-full object-cover" @click="openLightbox(formData.photos, idx)">
                            <button @click.stop="removePhoto(idx)" class="absolute top-1 right-1 bg-black/50 text-white rounded-full p-1">
                                <i data-lucide="x" class="w-3 h-3"></i>
                            </button>
                        </div>
                        
                        <div v-if="formData.photos.length < 3" 
                             @click="$refs.fileInput.click()"
                             class="w-24 h-24 flex flex-col items-center justify-center border-2 border-dashed border-gray-300 rounded-lg text-gray-400 hover:border-blue-500 hover:text-blue-500 bg-gray-50 flex-shrink-0 cursor-pointer">
                            <i data-lucide="camera" class="w-8 h-8 mb-1"></i>
                            <span class="text-xs">拍照/上傳</span>
                        </div>
                        <input type="file" ref="fileInput" class="hidden" accept="image/*" capture="environment" @change="handleImageUpload">
                    </div>

                    <button v-if="formData.photos.length > 0" 
                            @click="analyzeImage"
                            :disabled="isAnalyzing"
                            class="w-full py-3 rounded-lg flex items-center justify-center font-medium transition-colors border"
                            :class="isAnalyzing ? 'bg-purple-100 text-purple-400' : 'bg-purple-50 text-purple-700 hover:bg-purple-100 border-purple-200'">
                        <div v-if="isAnalyzing" class="loader mr-2"></div>
                        <i v-else data-lucide="sparkles" class="w-5 h-5 mr-2"></i>
                        {{ isAnalyzing ? 'AI 分析中...' : '以照片資訊快速帶入（目前需手動填寫）' }}
                    </button>
                </div>

                <!-- Fields -->
                <div class="space-y-4">
                    <!-- Name -->
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-1">資產名稱</label>
                        <input type="text" list="names-list" v-model="formData.name" placeholder="例如：MacBook Pro"
                               class="w-full border rounded-lg px-4 py-3 text-lg focus:ring-2 focus:ring-blue-500 outline-none">
                        <datalist id="names-list">
                            <option v-for="n in settings.savedNames" :value="n"></option>
                        </datalist>
                    </div>

                    <div class="grid grid-cols-2 gap-4">
                        <!-- Asset ID -->
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-1">資產編號</label>
                            <input type="text" list="prefix-list" v-model="formData.assetId" placeholder="0700-0253"
                                   class="w-full border rounded-lg pl-3 pr-2 py-3 focus:ring-2 focus:ring-blue-500 outline-none">
                            <datalist id="prefix-list">
                                <option v-for="p in settings.savedPrefixes" :value="p"></option>
                            </datalist>
                        </div>
                        <!-- S/N -->
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-1">序列號 (S/N)</label>
                            <input type="text" v-model="formData.serialNumber" placeholder="X1Y2Z3..."
                                   class="w-full border rounded-lg px-3 py-3 focus:ring-2 focus:ring-blue-500 outline-none font-mono text-sm">
                        </div>
                    </div>

                    <!-- Location -->
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-1">資產地點</label>
                        <input type="text" list="locations-list" v-model="formData.location" placeholder="例如：會議室 A"
                               class="w-full border rounded-lg px-4 py-3 focus:ring-2 focus:ring-blue-500 outline-none">
                        <datalist id="locations-list">
                            <option v-for="l in settings.savedLocations" :value="l"></option>
                        </datalist>
                    </div>

                    <!-- Note -->
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-1">備註 (移動需求)</label>
                        <textarea v-model="formData.note" placeholder="若資產需要移動，請填寫目標地點..."
                                  class="w-full border rounded-lg px-4 py-3 focus:ring-2 focus:ring-blue-500 outline-none h-24 resize-none"></textarea>
                    </div>
                </div>
            </div>
        </div>

        <!-- 4. SETTINGS VIEW -->
        <div v-if="view === 'SETTINGS'" class="h-full flex flex-col bg-white">
            <div class="bg-white border-b px-4 py-3 flex items-center shadow-sm sticky top-0 z-10">
                <button @click="view = 'CATEGORIES'" class="p-2 mr-2 rounded-full hover:bg-gray-100">
                    <i data-lucide="arrow-left" class="w-6 h-6 text-gray-700"></i>
                </button>
                <h1 class="text-xl font-bold text-gray-800">資料庫設定</h1>
            </div>

            <!-- Tabs -->
            <div class="flex border-b border-gray-200">
                <button @click="settingsTab = 'names'" class="flex-1 py-3 text-sm font-medium" :class="settingsTab === 'names' ? 'text-blue-600 border-b-2 border-blue-600' : 'text-gray-500'">資產名稱</button>
                <button @click="settingsTab = 'locations'" class="flex-1 py-3 text-sm font-medium" :class="settingsTab === 'locations' ? 'text-blue-600 border-b-2 border-blue-600' : 'text-gray-500'">地點清單</button>
                <button @click="settingsTab = 'prefixes'" class="flex-1 py-3 text-sm font-medium" :class="settingsTab === 'prefixes' ? 'text-blue-600 border-b-2 border-blue-600' : 'text-gray-500'">編號規則</button>
            </div>

            <!-- Content -->
            <div class="flex-1 overflow-y-auto p-4">
                <div class="flex gap-2 mb-4">
                    <input type="text" v-model="newSettingItem" @keyup.enter="addSettingItem" 
                           :placeholder="settingsTabName"
                           class="flex-1 border rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 outline-none">
                    <button @click="addSettingItem" class="bg-blue-600 text-white p-2 rounded-lg hover:bg-blue-700">
                        <i data-lucide="plus" class="w-5 h-5"></i>
                    </button>
                </div>

                <div class="space-y-2">
                    <div v-for="(item, idx) in currentSettingsList" :key="idx" class="flex items-center justify-between bg-gray-50 p-3 rounded-lg border">
                        <span class="text-gray-800">{{ item }}</span>
                        <button @click="removeSettingItem(idx)" class="text-red-500 p-2 hover:bg-red-50 rounded-full">
                            <i data-lucide="trash-2" class="w-4 h-4"></i>
                        </button>
                    </div>
                    <div v-if="currentSettingsList.length === 0" class="text-center text-gray-400 py-8">暫無資料</div>
                </div>
            </div>
        </div>

        <!-- ================= MODALS ================= -->

        <!-- Add Category Modal -->
        <div v-if="showCategoryModal" class="fixed inset-0 bg-black/60 z-50 flex items-center justify-center p-4 backdrop-blur-sm">
            <div class="bg-white rounded-2xl w-full max-w-sm p-6 shadow-2xl">
                <h3 class="text-xl font-bold mb-2 text-gray-800">新增盤點目錄</h3>
                <input type="text" v-model="newCategoryName" placeholder="例如：3F 會議室"
                       class="w-full border border-gray-300 rounded-lg p-3 mb-6 outline-none focus:ring-2 focus:ring-blue-500 text-lg">
                <div class="flex gap-3">
                    <button @click="showCategoryModal = false" class="flex-1 py-3 bg-gray-100 rounded-xl font-semibold text-gray-700">取消</button>
                    <button @click="createCategory" :disabled="!newCategoryName" class="flex-1 py-3 bg-blue-600 rounded-xl font-semibold text-white disabled:bg-blue-300">建立</button>
                </div>
            </div>
        </div>

        <!-- Lightbox -->
        <transition name="fade">
            <div v-if="lightbox.isOpen" @click="closeLightbox" class="fixed inset-0 bg-black z-[999] flex items-center justify-center">
                <button @click="closeLightbox" class="absolute top-4 right-4 text-white p-2 bg-white/20 rounded-full z-20">
                    <span class="text-3xl leading-none">✕</span>
                </button>
                
                <!-- Nav -->
                <button v-if="lightbox.images.length > 1" @click.stop="prevImage" class="absolute left-4 top-1/2 -translate-y-1/2 text-white p-3 bg-white/20 rounded-full z-20">
                    <span class="text-3xl leading-none">‹</span>
                </button>
                <button v-if="lightbox.images.length > 1" @click.stop="nextImage" class="absolute right-4 top-1/2 -translate-y-1/2 text-white p-3 bg-white/20 rounded-full z-20">
                    <span class="text-3xl leading-none">›</span>
                </button>

                <!-- Counter -->
                <div v-if="lightbox.images.length > 1" class="absolute bottom-8 left-1/2 -translate-x-1/2 text-white bg-black/50 px-3 py-1 rounded-full text-sm">
                    {{ lightbox.currentIndex + 1 }} / {{ lightbox.images.length }}
                </div>

                <img :src="lightbox.images[lightbox.currentIndex]" class="max-w-full max-h-full object-contain p-2">
            </div>
        </transition>

        <!-- PDF Template (Visible only when generating) -->
        <div v-if="isPdfPreview && activeCategory" class="fixed inset-0 z-[200] bg-white overflow-auto flex justify-center">
            <div id="pdf-report-content" class="bg-white w-[210mm] p-[15mm] text-gray-900 box-border">
                
                <div class="mb-6 pb-4 border-b-2 border-gray-800 flex justify-between items-end">
                    <div>
                        <h1 class="text-3xl font-extrabold tracking-wide mb-1">資產盤點清單</h1>
                        <p class="text-gray-600 font-medium">分類目錄: <span class="text-black">{{ activeCategory.name }}</span></p>
                    </div>
                    <div class="text-right text-sm text-gray-500">
                        <div>匯出日期: {{ new Date().toLocaleDateString('zh-TW') }}</div>
                    </div>
                </div>

                <table class="w-full border-collapse border border-gray-400 text-sm table-fixed">
                    <thead>
                        <tr class="bg-gray-100 text-gray-800">
                            <th class="border border-gray-400 p-2 w-[5%] text-center">#</th>
                            <th class="border border-gray-400 p-2 w-[25%] text-left">照片紀錄</th>
                            <th class="border border-gray-400 p-2 w-[35%] text-left">資產詳細資訊</th>
                            <th class="border border-gray-400 p-2 w-[15%] text-left">位置</th>
                            <th class="border border-gray-400 p-2 w-[20%] text-left">備註</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr v-for="(asset, index) in assets" :key="asset.id" class="align-top">
                            <td class="border border-gray-400 p-2 text-center">{{ index + 1 }}</td>
                            <td class="border border-gray-400 p-2">
                                <div v-if="asset.photos.length > 0" class="grid grid-cols-2 gap-1">
                                    <div v-for="(photo, i) in asset.photos.slice(0, 4)" :key="i" class="aspect-square w-full overflow-hidden border border-gray-200">
                                        <img :src="photo" class="w-full h-full object-cover">
                                    </div>
                                </div>
                                <span v-else class="text-gray-400 text-xs">- 無照片 -</span>
                            </td>
                            <td class="border border-gray-400 p-2 break-words">
                                <div class="space-y-1">
                                    <div><span class="font-bold text-gray-600 text-xs block">資產名稱:</span><span class="font-bold text-lg leading-tight block">{{ asset.name }}</span></div>
                                    <div><span class="font-bold text-gray-600 text-xs block">編號:</span><span class="font-mono text-sm block">{{ asset.assetId }}</span></div>
                                    <div><span class="font-bold text-gray-600 text-xs block">序號 (S/N):</span><span class="font-mono text-gray-700 text-xs break-all block">{{ asset.serialNumber || 'N/A' }}</span></div>
                                </div>
                            </td>
                            <td class="border border-gray-400 p-2 break-words">{{ asset.location }}</td>
                            <td class="border border-gray-400 p-2 text-gray-600 break-words text-xs">{{ asset.note }}</td>
                        </tr>
                    </tbody>
                </table>

                <div class="mt-8 pt-4 border-t border-gray-200 flex justify-between text-xs text-gray-400">
                    <div>Generated by AssetGuard AI</div>
                    <div>本頁共計: <span class="text-black font-bold">{{ assets.length }}</span> 筆資產</div>
                </div>
            </div>
        </div>

    </div>

    <!-- Application Logic -->
    <script type="module">
        const { createApp } = Vue;

        
        // --- Database Service ---
        const DB_NAME = 'AssetGuardDB';
        const DB_VERSION = 1;
        
        class DBService {
            constructor() { this.db = null; }
            connect() {
                return new Promise((resolve, reject) => {
                    const request = indexedDB.open(DB_NAME, DB_VERSION);
                    request.onerror = () => reject('DB Error');
                    request.onsuccess = (e) => { this.db = e.target.result; resolve(); };
                    request.onupgradeneeded = (e) => {
                        const db = e.target.result;
                        if (!db.objectStoreNames.contains('assets')) {
                            const store = db.createObjectStore('assets', { keyPath: 'id' });
                            store.createIndex('categoryId', 'categoryId', { unique: false });
                        }
                        if (!db.objectStoreNames.contains('categories')) db.createObjectStore('categories', { keyPath: 'id' });
                        if (!db.objectStoreNames.contains('settings')) db.createObjectStore('settings', { keyPath: 'id' });
                    };
                });
            }
            // Generic helpers
            getAll(storeName) {
                return new Promise(resolve => {
                    if (!this.db) return resolve([]);
                    const tx = this.db.transaction(storeName, 'readonly');
                    const req = tx.objectStore(storeName).getAll();
                    req.onsuccess = () => resolve(req.result);
                });
            }
            save(storeName, item) {
                return new Promise((resolve, reject) => {
                    try {
                        // 確保寫入 IndexedDB 的是「一般物件」，而不是 Vue 的 Proxy / reactive 物件
                        const plain = JSON.parse(JSON.stringify(item));
                        const tx = this.db.transaction(storeName, 'readwrite');
                        tx.objectStore(storeName).put(plain);
                        tx.oncomplete = () => resolve();
                        tx.onerror = (e) => reject(e.target.error || e);
                    } catch (e) {
                        console.error('儲存到 IndexedDB 失敗，無法序列化資料:', e, item);
                        reject(e);
                    }
                });
            }
            delete(storeName, id) {
                 return new Promise(resolve => {
                    const tx = this.db.transaction(storeName, 'readwrite');
                    tx.objectStore(storeName).delete(id);
                    tx.oncomplete = () => resolve();
                });
            }
            getByIndex(storeName, indexName, value) {
                return new Promise(resolve => {
                    const tx = this.db.transaction(storeName, 'readonly');
                    const idx = tx.objectStore(storeName).index(indexName);
                    const req = idx.getAll(value);
                    req.onsuccess = () => resolve(req.result);
                });
            }
        }
        const db = new DBService();

        // --- Gemini Service ---
        
        // （已移除 Gemini 相關程式碼）

        // --- Vue App ---
        createApp({
            data() {
                return {
                    view: 'CATEGORIES', // CATEGORIES, ASSET_LIST, ASSET_FORM, SETTINGS
                    categories: [],
                    assets: [],
                    activeCategory: null,
                    // 匯出 / 匯入相關狀態
                    showExportModal: false,
                    exportSelection: [],
                    settings: {
                        savedNames: ['筆記型電腦', '顯示器', '辦公桌'],
                        savedLocations: ['會議室 A', '庫房', '主要辦公區'],
                        savedPrefixes: ['ASSET-', 'IT-', 'OFFICE-'],
                        lastUsedPrefix: '',
                        lastUsedSequence: 1
                    },
                    
                    // Asset Form
                    editingAssetId: null,
                    formData: {
                        categoryId: '', photos: [], name: '', serialNumber: '', assetId: '', location: '', note: ''
                    },
                    isAnalyzing: false,

                    // Settings
                    settingsTab: 'names',
                    newSettingItem: '',

                    // Search
                    searchTerm: '',

                    // Modals
                    showCategoryModal: false,
                    newCategoryName: '',
                    
                    // Lightbox
                    lightbox: { isOpen: false, images: [], currentIndex: 0 },

                    // PDF
                    isPdfPreview: false,
                    isPdfGenerating: false
                }
            },
            computed: {
                filteredAssets() {
                    const term = this.searchTerm.toLowerCase();
                    return this.assets.filter(a => 
                        a.name.toLowerCase().includes(term) ||
                        a.assetId.toLowerCase().includes(term) ||
                        (a.location && a.location.toLowerCase().includes(term)) ||
                        (a.serialNumber && a.serialNumber.toLowerCase().includes(term))
                    );
                },
                currentSettingsList() {
                    if (this.settingsTab === 'names') return this.settings.savedNames;
                    if (this.settingsTab === 'locations') return this.settings.savedLocations;
                    return this.settings.savedPrefixes;
                },
                settingsTabName() {
                    if (this.settingsTab === 'names') return '新增名稱...';
                    if (this.settingsTab === 'locations') return '新增地點...';
                    return '新增前綴...';
                }
            },
            async mounted() {
                await db.connect();
                this.loadCategories();
                this.loadSettings();
                this.$nextTick(() => lucide.createIcons());
            },
            updated() {
                this.$nextTick(() => lucide.createIcons());
            },
            methods: {
                // Categories
                async loadCategories() {
                    this.categories = await db.getAll('categories');
                },
                async createCategory() {
                    if (!this.newCategoryName.trim()) return;
                    const cat = { id: crypto.randomUUID(), name: this.newCategoryName, description: '' };
                    await db.save('categories', cat);
                    this.newCategoryName = '';
                    this.showCategoryModal = false;
                    this.loadCategories();
                },
                async deleteCategory(id) {
                    if(!confirm('確定要刪除此目錄嗎？')) return;
                    await db.delete('categories', id);
                    this.loadCategories();
                },
                // 匯出 / 匯入目錄與資產
                openExportModal() {
                    if (!this.categories || !this.categories.length) {
                        alert('目前沒有目錄可以匯出');
                        return;
                    }
                    this.exportSelection = this.categories.map(c => c.id);
                    this.showExportModal = true;
                },
                closeExportModal() {
                    this.showExportModal = false;
                },
                toggleExportSelectAll() {
                    if (!this.categories || !this.categories.length) return;
                    if (this.exportSelection.length === this.categories.length) {
                        this.exportSelection = [];
                    } else {
                        this.exportSelection = this.categories.map(c => c.id);
                    }
                },
                async confirmExportSelection() {
                    if (!this.exportSelection || !this.exportSelection.length) {
                        alert('請先勾選要匯出的目錄');
                        return;
                    }
                    await this.exportSelectedBundle();
                    this.showExportModal = false;
                },
                async exportSelectedBundle() {
                    const selectedIds = Array.from(new Set(this.exportSelection || []));
                    if (!selectedIds.length) return;
                    const idSet = new Set(selectedIds);
                    const categories = this.categories.filter(c => idSet.has(c.id)).map(c => ({
                        id: c.id,
                        name: c.name,
                        description: c.description || ''
                    }));
                    // 讀取所有被選目錄的資產
                    const assets = [];
                    for (const cid of selectedIds) {
                        const list = await db.getByIndex('assets', 'categoryId', cid);
                        if (Array.isArray(list)) {
                            list.forEach(a => assets.push(a));
                        }
                    }
                    if (!categories.length) {
                        alert('沒有可匯出的目錄');
                        return;
                    }
                    const payload = {
                        type: 'assetguard_bundle',
                        version: 1,
                        exportedAt: new Date().toISOString(),
                        categories,
                        assets
                    };
                    const blob = new Blob([JSON.stringify(payload, null, 2)], { type: 'application/json' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    const dateStr = new Date().toISOString().slice(0,10).replace(/-/g,'');
                    a.download = `AssetGuard_Bundle_${dateStr}.json`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                },
                importBundle(event) {
                    const file = event.target.files && event.target.files[0];
                    if (!file) return;
                    const reader = new FileReader();
                    reader.onload = async (e) => {
                        try {
                            const text = e.target.result;
                            const data = JSON.parse(text);
                            const catList = Array.isArray(data.categories) ? data.categories : (Array.isArray(data) ? data : []);
                            const assetList = Array.isArray(data.assets) ? data.assets : [];
                            if (!Array.isArray(catList) || !catList.length) {
                                alert('匯入檔案格式不正確或沒有目錄資料');
                                return;
                            }
                            // 重新讀取目前目錄，避免舊資料
                            await this.loadCategories();
                            const genId = () => {
                                if (window.crypto && typeof window.crypto.randomUUID === 'function') {
                                    return window.crypto.randomUUID();
                                }
                                return Date.now().toString(36) + '-' + Math.random().toString(16).slice(2);
                            };
                            const nameToCat = {};
                            this.categories.forEach(c => { nameToCat[c.name] = c; });
                            const idMap = {}; // 舊 categoryId -> 新 categoryId
                            // 匯入目錄
                            for (const item of catList) {
                                const name = (item.name || '').trim();
                                if (!name) continue;
                                if (nameToCat[name]) {
                                    // 已存在，沿用現有 id
                                    idMap[item.id] = nameToCat[name].id;
                                    continue;
                                }
                                const cat = {
                                    id: genId(),
                                    name,
                                    description: item.description || ''
                                };
                                await db.save('categories', cat);
                                this.categories.push(cat);
                                nameToCat[name] = cat;
                                idMap[item.id] = cat.id;
                            }
                            // 匯入資產
                            for (const a of assetList) {
                                const oldCid = a.categoryId;
                                const newCid = idMap[oldCid];
                                if (!newCid) continue;
                                const asset = Object.assign({}, a);
                                asset.id = genId();
                                asset.categoryId = newCid;
                                if (!asset.createdAt) asset.createdAt = new Date().toISOString();
                                if (!asset.updatedAt) asset.updatedAt = asset.createdAt;
                                await db.save('assets', asset);
                            }
                            alert('匯入完成');
                        } catch (err) {
                            console.error('匯入資料失敗', err);
                            alert('匯入失敗，檔案格式可能不正確');
                        } finally {
                            event.target.value = '';
                        }
                    };
                    reader.readAsText(file, 'utf-8');
                },
                async enterCategory(cat) {
                    this.activeCategory = cat;
                    this.assets = await db.getByIndex('assets', 'categoryId', cat.id);
                    this.view = 'ASSET_LIST';
                },

                // Assets
                async deleteAsset(id) {
                    if(!confirm('確定要刪除此資產嗎？')) return;
                    await db.delete('assets', id);
                    if(this.activeCategory) this.enterCategory(this.activeCategory);
                },
                openAddAsset() {
                    this.editingAssetId = null;
                    this.formData = {
                        categoryId: this.activeCategory.id,
                        photos: [], name: '', serialNumber: '', assetId: '', location: '', note: ''
                    };
                    // Auto-ID
                    if (this.settings.lastUsedPrefix) {
                        const nextId = `${this.settings.lastUsedPrefix}${(this.settings.lastUsedSequence + 1).toString().padStart(4, '0')}`;
                        this.formData.assetId = nextId;
                    }
                    this.view = 'ASSET_FORM';
                },
                editAsset(asset) {
                    this.editingAssetId = asset.id;
                    this.formData = JSON.parse(JSON.stringify(asset));
                    this.view = 'ASSET_FORM';
                },
                async saveAsset() {
                    if (!this.formData.name) return alert('請輸入名稱');
                    // 這裡避免舊版瀏覽器沒有 crypto.randomUUID() 造成錯誤
                    const genId = () => {
                        if (window.crypto && typeof window.crypto.randomUUID === 'function') {
                            return window.crypto.randomUUID();
                        }
                        return Date.now().toString(36) + '-' + Math.random().toString(16).slice(2);
                    };
                    const asset = {
                        ...this.formData,
                        id: this.editingAssetId || genId(),
                        updatedAt: Date.now()
                    };
                    await db.save('assets', asset);
                    
                    // Update settings for auto-increment logic (simple)
                    if (this.formData.assetId) {
                         // Extract prefix if possible? (Skipping complex logic for brevity)
                    }

                    if (this.activeCategory) await this.enterCategory(this.activeCategory);
                },
                
                // Photos & AI
                handleImageUpload(e) {
                    const file = e.target.files[0];
                    if (!file) return;
                    const reader = new FileReader();
                    reader.onload = (evt) => {
                        this.resizeImage(evt.target.result, 800, 0.8, (resized) => {
                            if (this.formData.photos.length < 3) this.formData.photos.push(resized);
                        });
                    };
                    reader.readAsDataURL(file);
                },
                resizeImage(base64, maxWidth, quality, callback) {
                    const img = new Image();
                    img.src = base64;
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        let w = img.width, h = img.height;
                        if (w > maxWidth) { h = Math.round((h * maxWidth) / w); w = maxWidth; }
                        canvas.width = w; canvas.height = h;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, w, h);
                        callback(canvas.toDataURL('image/jpeg', quality));
                    };
                },
                removePhoto(idx) {
                    this.formData.photos.splice(idx, 1);
                },
                async analyzeImage() {
                    alert('目前未啟用自動分析功能，請自行填寫欄位');
                },

                // Lightbox
                openLightbox(images, idx) {
                    this.lightbox = { isOpen: true, images, currentIndex: idx };
                },
                closeLightbox() {
                    this.lightbox.isOpen = false;
                },
                nextImage() {
                    this.lightbox.currentIndex = (this.lightbox.currentIndex + 1) % this.lightbox.images.length;
                },
                prevImage() {
                    this.lightbox.currentIndex = (this.lightbox.currentIndex - 1 + this.lightbox.images.length) % this.lightbox.images.length;
                },

                // Settings
                async loadSettings() {
                    const s = await db.getAll('settings');
                    if (s && s.length > 0) {
                        // Merge assuming 'global' id
                        const global = s.find(x => x.id === 'global');
                        if (global) this.settings = { ...this.settings, ...global };
                    }
                },
                async saveSettings() {
                    await db.save('settings', { ...this.settings, id: 'global' });
                },
                addSettingItem() {
                    if (!this.newSettingItem.trim()) return;
                    if (this.settingsTab === 'names') this.settings.savedNames.push(this.newSettingItem.trim());
                    if (this.settingsTab === 'locations') this.settings.savedLocations.push(this.newSettingItem.trim());
                    if (this.settingsTab === 'prefixes') this.settings.savedPrefixes.push(this.newSettingItem.trim());
                    this.saveSettings();
                    this.newSettingItem = '';
                },
                removeSettingItem(idx) {
                    if (this.settingsTab === 'names') this.settings.savedNames.splice(idx, 1);
                    if (this.settingsTab === 'locations') this.settings.savedLocations.splice(idx, 1);
                    if (this.settingsTab === 'prefixes') this.settings.savedPrefixes.splice(idx, 1);
                    this.saveSettings();
                },

                // PDF：使用 html2pdf，在 Vue 之外建立獨立 DOM，再匯出（不修改任何 Vue 狀態）
                generatePDF() {
                    const category = this.activeCategory;
                    if (!category) {
                        alert('請先選擇目錄');
                        return;
                    }
                    const rows = this.filteredAssets || [];
                    if (!rows.length) {
                        alert('此目錄尚無任何資產，無法匯出');
                        return;
                    }

                    try {
                        // 建立一個獨立容器，不在 #app 裡，避免影響 Vue DOM
                        const wrapper = document.createElement('div');
                        wrapper.style.width = '210mm';
                        wrapper.style.padding = '15mm 10mm';
                        wrapper.style.boxSizing = 'border-box';
                        wrapper.style.backgroundColor = '#ffffff';
                        wrapper.style.color = '#111827';
                        wrapper.style.fontFamily = '-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica,Arial,sans-serif';
                        wrapper.style.fontSize = '11px';

                        const esc = (v) => (v == null ? '' : String(v))
                            .replace(/&/g, '&amp;')
                            .replace(/</g, '&lt;')
                            .replace(/>/g, '&gt;');

                        let html = '';
                        html += '<div style="font-size:18px;font-weight:700;margin:0 0 4px 0;">資產盤點清單</div>';
                        html += '<div style="margin:0 0 2px 0;font-size:11px;">分類目錄：' + esc(category.name || '') + '</div>';

                        const now = new Date();
                        const ts = now.getFullYear() + '/' +
                                   String(now.getMonth() + 1).padStart(2,'0') + '/' +
                                   String(now.getDate()).padStart(2,'0') + ' ' +
                                   String(now.getHours()).padStart(2,'0') + ':' +
                                   String(now.getMinutes()).padStart(2,'0');
                        html += '<div style="margin:0 0 8px 0;font-size:10px;color:#6b7280;">匯出日期：' + ts + '</div>';

                        // 表格外框
                        html += '<table style="width:100%;border-collapse:collapse;font-size:10px;table-layout:fixed;">';
                        html += '<thead><tr style="background:#e5e7eb;">'
                             + '<th style="border:1px solid #9ca3af;padding:4px;width:5%;">#</th>'
                             + '<th style="border:1px solid #9ca3af;padding:4px;width:30%;">照片記錄</th>'
                             + '<th style="border:1px solid #9ca3af;padding:4px;width:30%;">資產詳細資訊</th>'
                             + '<th style="border:1px solid #9ca3af;padding:4px;width:15%;">位置</th>'
                             + '<th style="border:1px solid #9ca3af;padding:4px;width:20%;">備註</th>'
                             + '</tr></thead><tbody>';

                        rows.forEach((a, idx) => {
                            const sn = esc(a.serialNumber || a.serial || 'N/A');
                            const code = esc(a.assetId || a.code || '');
                            const name = esc(a.name || '');
                            const loc = esc(a.location || '');
                            const note = esc(a.note || a.remark || '');

                            // 照片欄：多張照片垂直排列
                            let photosHtml = '';
                            if (Array.isArray(a.photos) && a.photos.length) {
                                a.photos.forEach((src) => {
                                    if (!src) return;
                                    photosHtml += '<div style="margin-bottom:4px;border:1px solid #e5e7eb;">'
                                                + '<img src="' + src + '" style="width:60mm;max-height:35mm;object-fit:contain;display:block;" />'
                                                + '</div>';
                                });
                            }

                            // 詳細資訊欄
                            let detailHtml = '';
                            detailHtml += '編號：' + code + '<br>';
                            detailHtml += 'S/N：' + sn + '<br>';
                            detailHtml += '名稱：' + name;

                            html += '<tr style="page-break-inside: avoid;">'
                                 + '<td style="border:1px solid #d1d5db;padding:4px;vertical-align:top;text-align:center;">' + (idx + 1) + '</td>'
                                 + '<td style="border:1px solid #d1d5db;padding:4px;vertical-align:top;">' + photosHtml + '</td>'
                                 + '<td style="border:1px solid #d1d5db;padding:4px;vertical-align:top;">' + detailHtml + '</td>'
                                 + '<td style="border:1px solid #d1d5db;padding:4px;vertical-align:top;">' + loc + '</td>'
                                 + '<td style="border:1px solid #d1d5db;padding:4px;vertical-align:top;">' + note + '</td>'
                                 + '</tr>';
                        });

                        html += '</tbody></table>';

                        // 頁尾
                        html += '<div style="margin-top:8px;font-size:9px;color:#6b7280;display:flex;justify-content:space-between;">'
                             + '<span>Generated by AssetGuard</span>'
                             + '<span>本頁共計：' + rows.length + ' 筆資產</span>'
                             + '</div>';

                        wrapper.innerHTML = html;
                        document.body.appendChild(wrapper);

                        const opt = {
                            margin: 0,
                            filename: (category.name || 'AssetReport') + '_AssetReport.pdf',
                            image: { type: 'jpeg', quality: 0.98 },
                            html2canvas: { scale: 2, useCORS: true, scrollY: 0 },
                            jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
                        };

                        // 直接用 html2pdf 以 wrapper 為來源產生 PDF
                        html2pdf().set(opt).from(wrapper).save().then(() => {
                            document.body.removeChild(wrapper);
                        }).catch(e => {
                            console.error('匯出失敗', e);
                            document.body.removeChild(wrapper);
                            alert('匯出失敗');
                        });
                    } catch (e) {
                        console.error('匯出 PDF 發生錯誤', e);
                        alert('匯出失敗');
                    }
                }
            }
        }).mount('#app');
    </script>
</body>
</html>